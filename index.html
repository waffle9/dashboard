<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Runic Command Suite</title>
    <style>
        :root {<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Runic Command Suite</title>
    <style>
        :root {
            /* Colors */
            --color-red: #e63946;
            --color-orange: #f4a261;
            --color-yellow: #e9c46a;
            --color-green: #2a9d8f;
            --color-blue: #264653;
            --color-purple: #9d4edd;
            --color-grey: #6c757d;
            --color-white: #f8f9fa;

            /* Light/Dark Mode */
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --card-bg-light: #2a2a2a;
            --text-color: #e0e0e0;
            --text-muted: #aaa;
            --border-color: #444;
            --input-bg: #2c2c2c;
            --shadow-color: rgba(0, 0, 0, 0.2);
        }

        body.light-mode {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --card-bg-light: #fdfdfd;
            --text-color: #1c1e21;
            --text-muted: #555;
            --border-color: #ddd;
            --input-bg: #f8f9fa;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        /* --- NEW: No-Scroll Page Layout --- */
        html, body {
            height: 100vh; /* Full viewport height */
            width: 100vw; /* Full viewport width */
            margin: 0;
            overflow: hidden; /* THIS PREVENTS BROWSER SCROLLING */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: grid; /* Use Grid for layout */
            grid-template-columns: 2fr 1fr; /* 2/3 column, 1/3 column */
            grid-template-rows: auto 1fr auto; /* Header, Main Content, Pips */
            grid-template-areas:
                "header header"
                "stats tools-right"
                "pips tools-right";
            padding: 16px;
            gap: 16px;
            box-sizing: border-box;
            font-size: 13px; /* Smaller base font */
        }

        h1, h2, h3 {
            text-align: center;
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 0.5rem; /* Reduced margin */
            flex-shrink: 0;
        }
        h2 { font-size: 1.2rem; }
        h3 { font-size: 0.9rem; margin: 0; }

        /* Generic panel style */
        .panel {
            padding: 12px; /* Reduced padding */
            background-color: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px var(--shadow-color);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* No scrolling */
        }

        /* --- Grid Area Layout --- */
        #header-panel {
            grid-area: header;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
        }
        #stats-panel {
            grid-area: stats;
            overflow-y: auto; /* Internal scroll for talents */
        }
        #pips-panel {
            grid-area: pips;
            flex-shrink: 0;
        }
        #right-column {
            grid-area: tools-right;
            display: grid;
            grid-template-rows: auto 1fr; /* Items, then Dice fills remaining */
            gap: 16px;
            overflow: hidden;
        }
        #items-panel {
            overflow-y: auto; /* Internal scroll for items */
        }
        #dice-panel {
            overflow-y: auto; /* Internal scroll for dice roller */
        }

        /* --- Header Panel --- */
        .char-name-input {
            width: 30%;
            font-size: 1.25rem;
            font-weight: bold;
            padding: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
        }
        .char-desc-textarea {
            width: 50%;
            height: 40px; /* Small */
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem;
            box-sizing: border-box;
            resize: none;
            font-size: 0.9rem;
        }
        
        /* --- Settings Button & Modal --- */
        #settings-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }
        #settings-btn:hover { color: var(--text-color); }
        
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0,0,0,0.6);
            z-index: 100;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            width: 500px;
            max-width: 90%;
            padding: 2rem;
            background-color: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-content h2 { margin-top: 0; }
        .modal-section { margin-bottom: 1.5rem; }
        .modal-section h3 {
            text-align: left;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .import-export { display: flex; flex-direction: column; gap: 10px; }
        .import-export-area {
            width: 100%;
            height: 80px;
            padding: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: none;
            font-family: monospace;
            box-sizing: border-box;
        }
        .modal-btn-group { display: flex; gap: 10px; }
        .modal-btn {
            flex-grow: 1;
            font-size: 1rem;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            color: white;
        }
        #export-btn { background-color: var(--color-blue); }
        #import-btn { background-color: var(--color-green); }
        #theme-toggle-btn { width: 100%; background-color: var(--color-grey); }
        #modal-close-btn, .modal-cancel-btn { 
            width: 100%; 
            background-color: var(--color-red); 
            margin-top: 1rem;
        }
        
        /* --- NEW: Item Modal Styles --- */
        .item-modal-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .item-modal-form label {
            font-weight: bold;
            font-size: 0.9rem;
        }
        .item-modal-form input {
            width: 100%;
            padding: 0.5rem;
            font-size: 1rem;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
        }
        .item-modal-form input[type="number"] {
            -moz-appearance: textfield;
        }
        .item-modal-inputs-row {
            display: flex;
            gap: 1rem;
        }
        .item-modal-inputs-row div {
            flex: 1;
        }
        #item-modal-save-btn { background-color: var(--color-green); margin-top: 1rem; }
        #item-modal-cancel-btn { background-color: var(--color-red); margin-top: 1rem; }


        /* --- CHARACTER SHEET STYLES --- */
        .sheet-table {
            width: 100%;
            margin: 0 auto;
            border-collapse: collapse;
            table-layout: fixed;
        }
        .sheet-table th,
        .sheet-table td {
            border: 1px solid var(--border-color);
            padding: 3px; /* TIGHT padding */
            vertical-align: middle; /* Changed */
            text-align: left;
            word-wrap: break-word;
        }
        .sheet-table th {
            background-color: #333;
            color: var(--white);
            text-align: center;
            font-size: 9px; /* TINY font */
            padding: 3px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* Column Widths */
        .col-talent { width: 10%; }
        .col-uses { width: 12%; }
        .col-tracker { width: 30%; }
        .col-lvl { width: 8%; } 
        .col-attribute { width: 11%; } /* Thinner */
        .col-sparks { width: 11%; } /* Thinner */
        .col-odyssey { width: 11%; } /* Thinner */
        .col-roll { width: 7%; } /* NEW Roll column */

        .talent-name {
            font-weight: bold;
            font-size: 1rem; /* Small */
            margin: 0;
        }
        .talent-uses {
            font-size: 0.75rem; /* Small */
            color: var(--text-muted);
            margin: 0;
        }
        .tracker-icons {
            display: flex;
            justify-content: space-around;
            margin-bottom: 4px; /* TIGHT */
        }
        .tracker-icon {
            width: 18px; /* SMALL */
            height: 18px; /* SMALL */
            border: 2px solid var(--border-color);
            cursor: pointer;
            opacity: 0.3;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 8px; /* TINY */
            user-select: none;
        }
        .tracker-icon[data-toggled="true"] { opacity: 1; border-width: 2px; }
        
        #icon-novice { background-color: var(--color-red); border-color: var(--color-red); border-radius: 50%; }
        #icon-trained { background-color: var(--color-orange); border-color: var(--color-orange); border-radius: 4px; }
        #icon-skilled { background-color: var(--color-yellow); border-color: var(--color-yellow); border-radius: 50%; }
        #icon-expert { background-color: var(--color-green); border-color: var(--color-green); width: 0; height: 0; border-left: 9px solid transparent; border-right: 9px solid transparent; border-bottom: 16px solid var(--color-green); }
        #icon-master { background-color: var(--color-blue); border-color: var(--color-blue); transform: rotate(45deg); }
        
        .tracker-dots {
            display: flex;
            justify-content: space-between;
            background: #222;
            padding: 4px; /* TIGHT */
            border-radius: 4px;
            align-items: center;
        }
        .tracker-dot {
            width: 9px; /* SMALL */
            height: 9px; /* SMALL */
            background-color: #444;
            border-radius: 50%;
            cursor: pointer;
        }
        .tracker-dot.filled { background-color: var(--color-green); }
        /* CORRECTED: 1+2+3+4 layout */
        .tracker-dot:nth-child(1),
        .tracker-dot:nth-child(3),
        .tracker-dot:nth-child(6) {
            margin-right: 6px; /* TIGHT */
        }

        .talent-lvl-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .talent-lvl-display {
            width: 50px; /* NARROW */
            height: 30px; /* SHORT */
            font-size: 1rem; /* Small */
            font-weight: bold;
            text-align: center;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .attr-cell {
            padding: 6px; /* TIGHT */
            background-color: var(--card-bg-light);
            vertical-align: middle; /* Center content vertically */
            text-align: center; /* Center column content */
        }
        .attr-cell h3 {
            margin: 0 0 6px 0;
            text-align: center; /* Center header */
            font-size: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 3px;
        }
        
        .score-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .attr-score-input {
            width: 50px; /* NARROW */
            padding: 4px; /* TIGHT */
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
            text-align: center;
            font-weight: bold;
            -moz-appearance: textfield;
            height: 30px; /* SHORT */
        }
        
        .dice-rank-icon {
            width: 22px; /* SMALL */
            height: 22px; /* SMALL */
            background-color: transparent;
            border: 0;
            transition: all 0.2s ease-in-out;
            margin: 0 auto;
            border-radius: 0;
            transform: rotate(0deg);
            clip-path: none;
        }
        .dice-rank-none { border: 2px dashed var(--border-color); border-radius: 50%; }
        .dice-rank-1 { width: 0; height: 0; border-left: 11px solid transparent; border-right: 11px solid transparent; border-bottom: 19px solid var(--color-red); }
        .dice-rank-2 { background-color: var(--color-orange); border: 2px solid var(--color-orange); border-radius: 4px; }
        .dice-rank-3 { background-color: var(--color-yellow); border: 2px solid var(--color-yellow); transform: rotate(45deg); }
        .dice-rank-4 { width: 0; height: 0; border-left: 11px solid transparent; border-right: 11px solid transparent; border-bottom: 19px solid var(--color-green); }
        .dice-rank-5 { width: 22px; height: 21px; background-color: var(--color-blue); clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%); }

        /* --- Roll Button --- */
        .roll-cell {
            text-align: center;
            vertical-align: middle;
        }
        .roll-talent-btn {
            background: var(--color-blue);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px; /* Smaller */
            height: 32px; /* Smaller */
            cursor: pointer;
            font-size: 9px; /* Smaller */
            font-weight: bold;
            line-height: 1;
            padding: 0;
        }
        .roll-talent-btn:hover {
            opacity: 0.8;
        }

        /* --- Pips Panel --- */
        #pips-panel .panel-content {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }
        .pip-input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            flex-grow: 1;
        }
        .pip-label {
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        .pip-input {
            width: 100%;
            height: 30px; /* SHORT */
            font-size: 1rem; /* SMALL */
            font-weight: bold;
            text-align: center;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 2px solid var(--border-color);
            border-radius: 4px;
            -moz-appearance: textfield;
            box-sizing: border-box;
            /* --- NEW: Make Pips Readonly --- */
            background-color: var(--card-bg-light); 
            opacity: 0.8;
        }
        #pip-might { border-color: var(--color-red); }
        #pip-agility { border-color: var(--color-orange); }
        #pip-passion { border-color: var(--color-yellow); }
        #pip-mind { border-color: var(--color-green); }
        #pip-presence { border-color: var(--color-blue); }

        
        /* --- PIP TRACKER CARDS (NOW IN DICE ROLLER) --- */
        .tracker-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        .tracker-card {
            background-color: var(--card-bg-light);
            border-top: 4px solid;
            border-radius: 8px;
            width: 100%;
            padding: 1rem;
            box-sizing: border-box;
        }
        .tracker-card h2 { margin-top: 0; font-size: 1.1rem; }
        #stamina { border-color: var(--color-red); }
        #dexterity { border-color: var(--color-orange); }
        #essence { border-color: var(--color-yellow); }
        #clarity { border-color: var(--color-green); }
        #grit { border-color: var(--color-blue); }

        .max-pip-setter {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .max-pip-setter label {
            font-size: 0.9rem;
        }
        .max-pip-input { /* Changed from input to div */
            width: 50px;
            padding: 0.25rem;
            font-size: 0.9rem;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            text-align: center;
            font-weight: bold;
            border-radius: 4px;
        }
        .max-pip-setter button {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            background-color: #555;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .pip-zone {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0; /* TIGHT */
            border-bottom: 1px solid #333;
        }
        .pip-zone:last-child { border-bottom: none; }
        .tier-name { font-weight: 500; color: var(--text-muted); font-size: 0.9rem; }
        .pip-value { font-size: 1.1rem; font-weight: bold; min-width: 30px; text-align: right; }
        
        #apply-damage { background-color: var(--color-red); color: white; }
        #apply-heal { background-color: var(--color-green); color: white; }

        
        /* --- DICE ROLLER STYLES --- */
        #dice-roller {
            display: grid;
            grid-template-areas:
                "selection selection"
                "controls controls"
                "results tally"
                "bank bank";
            gap: 1rem; /* TIGHT */
        }
        #dice-selection { grid-area: selection; display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; }
        #dice-controls { grid-area: controls; display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;}
        #dice-results { grid-area: results; }
        #dice-tally { grid-area: tally; }
        #dice-bank { grid-area: bank; text-align: center; border-top: 1px solid var(--border-color); padding-top: 1rem; }

        #dice-roller h3 { margin-top: 0; margin-bottom: 0.5rem; font-size: 1rem; }
        #dice-roller .roll-button { background-color: #0077b6; color: white; font-size: 1rem; padding: 0.5rem 1rem; }
        #dice-roller .special-roll { display: flex; align-items: center; gap: 0.25rem; }
        
        #raw-roll-results { 
            font-size: 1.1rem; 
            letter-spacing: 0.1rem; 
            text-align: center; 
            background: var(--card-bg-light); 
            padding: 0.5rem; 
            border-radius: 6px; 
            min-height: 2rem; 
        }
        
        .tally-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; font-size: 0.9rem; }
        .tally-row .label { font-weight: 500; }
        .tally-row .value { font-weight: bold; font-size: 1.1rem; min-width: 25px; text-align: right; }
        .tally-row .tally-buttons button { font-size: 0.7rem; padding: 0.1rem 0.4rem; margin-left: 0.25rem; }
        
        #success-level { padding: 0.25rem 0.5rem; border-radius: 4px; color: white; font-weight: bold; }
        
        #dice-bank button, #apply-fails-button {
            background-color: #444;
            color: white;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        #apply-fails-button {
            background-color: var(--color-red);
            margin-top: 0.5rem;
            width: 100%;
        }

        /* --- NEW: Custom Select Dropdowns --- */
        #dice-roller select, #pip-controls select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 2rem 0.5rem 1rem; /* Add padding for arrow */
            font-size: 1rem;
            color: var(--text-color);
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23aaa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
        }

        body.light-mode #dice-roller select, 
        body.light-mode #pip-controls select {
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23555' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }
        /* --- End Custom Select --- */
        
      /* --- Items Panel --- */
        #item-list {
            display: flex;
            flex-wrap: wrap; /* Changed */
            gap: 8px; /* Changed */
            background-color: var(--card-bg-light);
            padding: 8px;
            border-radius: 4px;
        }
        /* NEW: Item Card Style */
        .item-card {
            width: 80px;
            height: 80px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            box-sizing: border-box;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative; /* For the quantity */
        }
        .item-card:hover {
            background-color: var(--card-bg-light);
            border-color: var(--color-blue);
        }
        .item-card .dice-rank-icon {
            margin-bottom: 8px;
        }
        .item-card .item-name {
            font-size: 0.8rem;
            text-align: center;
            color: var(--text-color);
            font-weight: bold;
            word-break: break-word;
            line-height: 1.2;
            /* Clamp to 2 lines */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        /* New Quantity Badge */
        .item-card-qty {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--color-red);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            border: 1px solid var(--card-bg);
        }

    </style>
</head>
<body class="dark-mode">

    <!-- 1. Main Header (No Scroll) -->
    <div id="header-panel" class="panel">
        <input type="text" id="char-name" class="char-name-input" placeholder="Character Name">
        <textarea id="char-desc" class="char-desc-textarea" placeholder="Base character descriptions..."></textarea>
        <button id="settings-btn" title="Settings">
            <!-- SVG Gear Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        </button>
    </div>

    <!-- 2. Stats Panel (Left) -->
    <div id="stats-panel" class="panel">
        <table class="sheet-table">
            <thead>
                <tr>
                    <th class="col-talent">TALENT</th>
                    <th class="col-uses">USES</th>
                    <th class="col-tracker">TRACKER</th>
                    <th class="col-lvl">TALENT LVL</th>
                    <th class="col-attribute">ATTRIBUTE</th>
                    <th class="col-sparks">SPARKS</th>
                    <th class="col-odyssey">ODYSSEY ECHOES</th>
                    <th class="col-roll">ROLL</th>
                </tr>
            </thead>
            <tbody>
                <!-- MIGHT -->
                <tr data-talent-id="strength" data-attr-id="might">
                    <td><h3 class="talent-name" style="color: var(--color-red);">STRENGTH</h3></td>
                    <td><p class="talent-uses">Athletics<br>Force</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <!-- 1 + 2 + 3 + 4 = 10 bubbles -->
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-strength">0</div>
                            <div class="dice-rank-icon" id="icon-talent-strength"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #2a1a1c;">
                        <h3>MIGHT</h3>
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="attr-score-might" placeholder="0" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-score-might"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #2a1a1c;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="sparks-might-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-sparks-might"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #2a1a1c;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="odyssey-might-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-odyssey-might"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="might" data-talent="strength">ROLL</button></td>
                </tr>
                <tr data-talent-id="endurance" data-attr-id="might">
                    <td><h3 class="talent-name" style="color: var(--color-red);">ENDURANCE</h3></td>
                    <td><p class="talent-uses">Fortitude<br>Perseverance</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-endurance">0</div>
                            <div class="dice-rank-icon" id="icon-talent-endurance"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="might" data-talent="endurance">ROLL</button></td>
                </tr>
                <tr data-talent-id="prowess" data-attr-id="might">
                    <td><h3 class="talent-name" style="color: var(--color-red);">PROWESS</h3></td>
                    <td><p class="talent-uses">Melee<br>Expertise</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-prowess">0</div>
                            <div class="dice-rank-icon" id="icon-talent-prowess"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="might" data-talent="prowess">ROLL</button></td>
                </tr>
                <!-- AGILITY -->
                <tr data-talent-id="balance" data-attr-id="agility">
                    <td><h3 class="talent-name" style="color: var(--color-orange);">BALANCE</h3></td>
                    <td><p class="talent-uses">Acrobatics<br>Maneuvers</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-balance">0</div>
                            <div class="dice-rank-icon" id="icon-talent-balance"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #2a221a;">
                        <h3>AGILITY</h3>
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="attr-score-agility" placeholder="0" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-score-agility"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #2a221a;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="sparks-agility-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-sparks-agility"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #2a221a;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="odyssey-agility-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-odyssey-agility"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="agility" data-talent="balance">ROLL</button></td>
                </tr>
                <tr data-talent-id="finesse" data-attr-id="agility">
                    <td><h3 class="talent-name" style="color: var(--color-orange);">FINESSE</h3></td>
                    <td><p class="talent-uses">Precision<br>Detail</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-finesse">0</div>
                            <div class="dice-rank-icon" id="icon-talent-finesse"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="agility" data-talent="finesse">ROLL</button></td>
                </tr>
                <tr data-talent-id="focus" data-attr-id="agility">
                    <td><h3 class="talent-name" style="color: var(--color-orange);">FOCUS</h3></td>
                    <td><p class="talent-uses">Accuracy<br>Reaction</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-focus">0</div>
                            <div class="dice-rank-icon" id="icon-talent-focus"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="agility" data-talent="focus">ROLL</button></td>
                </tr>
                <!-- PASSION -->
                <tr data-talent-id="power" data-attr-id="passion">
                    <td><h3 class="talent-name" style="color: var(--color-yellow);">POWER</h3></td>
                    <td><p class="talent-uses">Sorcery<br>Emotion</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-power">0</div>
                            <div class="dice-rank-icon" id="icon-talent-power"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #2a281a;">
                        <h3>PASSION</h3>
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="attr-score-passion" placeholder="0" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-score-passion"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #2a281a;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="sparks-passion-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-sparks-passion"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #2a281a;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="odyssey-passion-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-odyssey-passion"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="passion" data-talent="power">ROLL</button></td>
                </tr>
                <tr data-talent-id="core" data-attr-id="passion">
                    <td><h3 class="talent-name" style="color: var(--color-yellow);">CORE</h3></td>
                    <td><p class="talent-uses">Faith<br>Morality</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-core">0</div>
                            <div class="dice-rank-icon" id="icon-talent-core"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="passion" data-talent="core">ROLL</button></td>
                </tr>
                <tr data-talent-id="creativity" data-attr-id="passion">
                    <td><h3 class="talent-name" style="color: var(--color-yellow);">CREATIVITY</h3></td>
                    <td><p class="talent-uses">Artistry<br>Invention</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-creativity">0</div>
                            <div class="dice-rank-icon" id="icon-talent-creativity"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="passion" data-talent="creativity">ROLL</button></td>
                </tr>
                <!-- MIND -->
                <tr data-talent-id="insight" data-attr-id="mind">
                    <td><h3 class="talent-name" style="color: var(--color-green);">INSIGHT</h3></td>
                    <td><p class="talent-uses">Investigation<br>Awareness</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-insight">0</div>
                            <div class="dice-rank-icon" id="icon-talent-insight"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #1a2a26;">
                        <h3>MIND</h3>
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="attr-score-mind" placeholder="0" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-score-mind"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #1a2a26;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="sparks-mind-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-sparks-mind"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #1a2a26;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="odyssey-mind-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-odyssey-mind"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="mind" data-talent="insight">ROLL</button></td>
                </tr>
                <tr data-talent-id="aptitude" data-attr-id="mind">
                    <td><h3 class="talent-name" style="color: var(--color-green);">APTITUDE</h3></td>
                    <td><p class="talent-uses">Knowledge<br>Memory</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-aptitude">0</div>
                            <div class="dice-rank-icon" id="icon-talent-aptitude"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="mind" data-talent="aptitude">ROLL</button></td>
                </tr>
                <tr data-talent-id="ingenuity" data-attr-id="mind">
                    <td><h3 class="talent-name" style="color: var(--color-green);">INGENUITY</h3></td>
                    <td><p class="talent-uses">Engineering<br>Tactics</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-ingenuity">0</div>
                            <div class="dice-rank-icon" id="icon-talent-ingenuity"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="mind" data-talent="ingenuity">ROLL</button></td>
                </tr>
                <!-- PRESENCE -->
                <tr data-talent-id="influence" data-attr-id="presence">
                    <td><h3 class="talent-name" style="color: var(--color-blue);">INFLUENCE</h3></td>
                    <td><p class="talent-uses">Persuasion<br>Intimidation</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-influence">0</div>
                            <div class="dice-rank-icon" id="icon-talent-influence"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #1a1e2a;">
                        <h3>PRESENCE</h3>
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="attr-score-presence" placeholder="0" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-score-presence"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #1a1e2a;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="sparks-presence-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-sparks-presence"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #1a1e2a;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="odyssey-presence-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-odyssey-presence"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="presence" data-talent="influence">ROLL</button></td>
                </tr>
                <tr data-talent-id="guile" data-attr-id="presence">
                    <td><h3 class="talent-name" style="color: var(--color-blue);">GUILE</h3></td>
                    <td><p class="talent-uses">Deception<br>Stealth</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon"id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-guile">0</div>
                            <div class="dice-rank-icon" id="icon-talent-guile"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="presence" data-talent="guile">ROLL</button></td>
                </tr>
                <tr data-talent-id="intuition" data-attr-id="presence">
                    <td><h3 class="talent-name" style="color: var(--color-blue);">INTUITION</h3></td>
                    <td><p class="talent-uses">Instinct<br>Wisdom</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-intuition">0</div>
                            <div class="dice-rank-icon" id="icon-talent-intuition"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="presence" data-talent="intuition">ROLL</button></td>
                </tr>
            </tbody>
        </table>
    </div> <!-- End stats-panel -->

    <!-- 3. Pips Panel (Left) -->
    <div id="pips-panel" class="panel">
        <div class="panel-content">
            <div class="pip-input-container">
                <label for="pip-might" class="pip-label" style="color: var(--color-red);">Stamina</label>
                <input type="number" class="pip-input" id="pip-might" min="0" value="0" readonly>
            </div>
            <div class="pip-input-container">
                <label for="pip-agility" class="pip-label" style="color: var(--color-orange);">Dexterity</label>
                <input type="number" class="pip-input" id="pip-agility" min="0" value="0" readonly>
            </div>
            <div class="pip-input-container">
                <label for="pip-passion" class="pip-label" style="color: var(--color-yellow);">Essence</label>
                <input type="number" class="pip-input" id="pip-passion" min="0" value="0" readonly>
            </div>
            <div class="pip-input-container">
                <label for="pip-mind" class="pip-label" style="color: var(--color-green);">Clarity</label>
                <input type="number" class="pip-input" id="pip-mind" min="0" value="0" readonly>
            </div>
            <div class="pip-input-container">
                <label for="pip-presence" class="pip-label" style="color: var(--color-blue);">Grit</label>
                <input type="number" class="pip-input" id="pip-presence" min="0" value="0" readonly>
            </div>
        </div>
    </div> <!-- End pips-panel -->


    <!-- ========================== -->
    <!-- 4. RIGHT COLUMN (Tools)    -->
    <!-- ========================== -->
    <div id="right-column">
        <!-- 4a. Items Panel -->
        <div id="items-panel" class="panel">
            <h2>Items</h2>
            <div id="item-list">
                <!-- Items will be added here by JS -->
            </div>
            <button id="add-item-btn" class="modal-btn" style="background-color: var(--color-green);">Add New Item</button>
        </div>
        
        <!-- 4b. Dice Panel -->
        <div id="dice-panel" class="panel">
            <!-- Dice Roller -->
            <h2>Dice Roller</h2>
            <div id="dice-roller" class="controls" style="padding: 0; border: 0; box-shadow: none;">
                <div id="dice-selection">
                    <select id="die-1">
                        <option value="d3(4)">d3(4)</option><option value="d6">d6</option><option value="d8" selected>d8</option><option value="d10">d10</option><option value="d12">d12</option>
                    </select>
                    <select id="die-2">
                        <option value="d3(4)">d3(4)</option><option value="d6">d6</option><option value="d8" selected>d8</option><option value="d10">d10</option><option value="d12">d12</option>
                    </select>
                    <select id="die-3">
                        <option value="d3(4)">d3(4)</option><option value="d6" selected>d6</option><option value="d8">d8</option><option value="d10">d10</option><option value="d12">d12</option>
                    </select>
                    <select id="die-4">
                        <option value="d3(4)">d3(4)</option><option value="d6" selected>d6</option><option value="d8">d8</option><option value="d10">d10</option><option value="d12">d12</option>
                    </select>
                </div>
                <div id="dice-controls">
                    <button id="roll-button" class="roll-button">Roll Dice</button>
                    <div class="special-roll">
                        <input type="checkbox" id="special-roll-check">
                        <label for="special-roll-check">Special Roll?</label>
                    </div>
                    <select id="roll-aspect-risk">
                        <option value="stamina">Stamina</option><option value="dexterity">Dexterity</option><option value="essence">Essence</option><option value="clarity">Clarity</option><option value="grit">Grit</option>
                    </select>
                </div>
                <div id="dice-results">
                    <h3>Raw Roll</h3>
                    <div id="raw-roll-results"></div>
                    <h3>Ultimate Bank</h3>
                    <div id="dice-bank">
                        <span>Stored Ultimates: <span id="stored-ultimates-val">0</span></span>
                        <button id="bank-use-s">Spend as (S)</button>
                        <button id="bank-use-f">Spend as (F)</button>
                    </div>
                </div>
                <div id="dice-tally">
                    <h3>Tally</h3>
                    <div class="tally-row">
                        <span class="label">Success Level:</span>
                        <span id="success-level" style="background-color: #888;">None</span>
                    </div>
                    <div class="tally-row">
                        <span class="label">Successes:</span>
                        <span class="value" id="tally-s">0</span>
                    </div>
                    <div class="tally-row">
                        <span class="label">Fails:</span>
                        <span class="value" id="tally-f">0</span>
                    </div>
                    <div class="tally-row">
                        <span class="label">Ultimates:</span>
                        <span class="value" id="tally-u">0</span>
                        <span class="tally-buttons">
                            <button id="tally-u-s">[+S]</button>
                            <button id="tally-u-f">[+F]</button>
                            <button id="tally-u-bank">[Bank]</button>
                        </span>
                    </div>
                    <button id="apply-fails-button">Apply Fails as Damage</button>
                </div>
            </div>

            <!-- Pip Controls -->
            <h2 style="margin-top: 1.5rem;">Pip Controls</h2>
            <div class="controls" id="pip-controls" style="padding: 0; border: 0; box-shadow: none;">
                <label for="pip-amount">Amount:</label>
                <input type="number" id="pip-amount" value="1" min="1">
                <label for="pip-category">For:</label>
                <select id="pip-category">
                    <option value="stamina">Stamina</option>
                    <option value="dexterity">Dexterity</option>
                    <option value="essence">Essence</option>
                    <option value="clarity">Clarity</option>
                    <option value="grit">Grit</option>
                </select>
                <button id="apply-damage">Subtract Pips</button>
                <button id="apply-heal">Add Pips</button>
            </div>
            
            <!-- Pip Tracker Cards (Full) -->
            <div class="tracker-container" id="pip-tracker-section" style="margin-top: 1.5rem;">
                <!-- Stamina -->
                <div class="tracker-card" id="stamina">
                    <h2>Stamina</h2>
                    <div class="max-pip-setter">
                        <label>Max Pips:</label>
                        <!-- Now a div, not an input -->
                        <div class="max-pip-input" data-category="stamina">0</div>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Stalwart:</span>
                        <span class="pip-value" id="stamina-t1">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Fatigued:</span>
                        <span class="pip-value" id="stamina-t2">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Exhausted:</span>
                        <span class="pip-value" id="stamina-t3">0</span>
                    </div>
                </div>
                <!-- Dexterity -->
                <div class="tracker-card" id="dexterity">
                    <h2>Dexterity</h2>
                    <div class="max-pip-setter">
                        <label>Max Pips:</label>
                        <div class="max-pip-input" data-category="dexterity">0</div>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Limber:</span>
                        <span class="pip-value" id="dexterity-t1">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Unsteady:</span>
                        <span class="pip-value" id="dexterity-t2">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Impaired:</span>
                        <span class="pip-value" id="dexterity-t3">0</span>
                    </div>
                </div>
                <!-- Essence -->
                <div class="tracker-card" id="essence">
                    <h2>Essence</h2>
                    <div class="max-pip-setter">
                        <label>Max Pips:</label>
                        <div class="max-pip-input" data-category="essence">0</div>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Energized:</span>
                        <span class="pip-value" id="essence-t1">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Meaning:</span>
                        <span class="pip-value" id="essence-t2">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Hollow:</span>
                        <span class="pip-value" id="essence-t3">0</span>
                    </div>
                </div>
                <!-- Clarity -->
                <div class="tracker-card" id="clarity">
                    <h2>Clarity</h2>
                    <div class="max-pip-setter">
                        <label>Max Pips:</label>
                        <div class="max-pip-input" data-category="clarity">0</div>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Rational:</span>
                        <span class="pip-value" id="clarity-t1">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Unhinged:</span>
                        <span class="pip-value" id="clarity-t2">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Crazed:</span>
                        <span class="pip-value" id="clarity-t3">0</span>
                    </div>
                </div>
                <!-- Grit -->
                <div class="tracker-card" id="grit">
                    <h2>Grit</h2>
                    <div class="max-pip-setter">
                        <label>Max Pips:</label>
                        <div class="max-pip-input" data-category="grit">0</div>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Focused:</span>
                        <span class="pip-value" id="grit-t1">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Distracted:</span>
                        <span class="pip-value" id="grit-t2">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Withdrawn:</span>
                        <span class="pip-value" id="grit-t3">0</span>
                    </div>
                </div>
            </div> <!-- End tracker-container -->
        </div> <!-- End dice-panel -->
    </div> <!-- End right-column -->


    <!-- ========================== -->
    <!-- 5. Settings Modal (Hidden) -->
    <!-- ========================== -->
    <div id="settings-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2>Settings</h2>
            
            <div class="modal-section">
                <h3>Theme</h3>
                <button id="theme-toggle-btn" class="modal-btn">Toggle Light/Dark Mode</button>
            </div>

            <div class="modal-section">
                <h3>Character Data</h3>
                <div class="import-export">
                    <textarea id="import-export-data" class="import-export-area" placeholder="Paste character code here..."></textarea>
                    <div class="modal-btn-group">
                        <button id="export-btn" class="modal-btn">Generate Export Code</button>
                        <button id="import-btn" class="modal-btn">Load from Code</button>
                    </div>
                </div>
            </div>

            <button id="modal-close-btn" class="modal-btn">Close</button>
        </div>
    </div>
    
    <!-- ========================== -->
    <!-- 6. Add Item Modal (Hidden) -->
    <!-- ========================== -->
    <div id="add-item-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2>Add New Item</h2>
            <div class="item-modal-form">
                <div>
                    <label for="item-modal-name">Item Name</label>
                    <input type="text" id="item-modal-name" placeholder="Potion of Healing">
                </div>
                <div>
                    <label for="item-modal-desc">Description</label>
                    <input type="text" id="item-modal-desc" placeholder="Restores 5 stamina pips.">
                </div>
                <div class="item-modal-inputs-row">
                    <div>
                        <label for="item-modal-qty">Quantity</label>
                        <input type="number" id="item-modal-qty" value="1" min="1">
                    </div>
                    <div>
                        <label for="item-modal-value">Value (0-5)</label>
                        <input type="number" id="item-modal-value" value="1" min="0" max="5">
                    </div>
                </div>
                <div class="modal-btn-group">
                    <button id="item-modal-save-btn" class="modal-btn">Save Item</button>
                    <button id="item-modal-cancel-btn" class="modal-btn modal-cancel-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>
<!-- ========================== -->
    <!-- 7. View Item Modal (Hidden) -->
    <!-- ========================== -->
    <div id="view-item-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2>View Item</h2>
            <form class="item-modal-form" id="view-item-form">
                <input type="hidden" id="view-item-id">
                <div>
                    <label for="view-item-name">Item Name</label>
                    <input type="text" id="view-item-name">
                </div>
                <div>
                    <label for="view-item-desc">Description</label>
                    <textarea id="view-item-desc"></textarea>
                </div>
                <div class="item-modal-inputs-row">
                    <div>
                        <label for="view-item-qty">Quantity</label>
                        <input type="number" id="view-item-qty" min="0">
                    </div>
                    <div>
                        <label for="view-item-value">Value (0-5)</label>
                        <input type="number" id="view-item-value" min="0" max="5">
                    </div>
                </div>
                <div class="modal-btn-group">
                    <button id="view-item-save-btn" type="submit" class="modal-btn">Save Changes</button>
                    <button id="view-item-delete-btn" type="button" class="modal-btn">Delete Item</button>
                </div>
                 <button id="view-item-close-btn" type="button" class="modal-btn modal-cancel-btn">Close</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // ==================================
            // --- TOP-LEVEL DECLARATIONS ---
            // ==================================
            const pipCategories = ['stamina', 'dexterity', 'essence', 'clarity', 'grit'];
            const attrToPip = {
                'might': 'stamina',
                'agility': 'dexterity',
                'passion': 'essence',
                'mind': 'clarity',
                'presence': 'grit'
            };
            let trackers = {};
            let items = [];

            const talentIds = [
                'strength', 'endurance', 'prowess', 'balance', 'finesse', 'focus',
                'power', 'core', 'creativity', 'insight', 'aptitude', 'ingenuity',
                'influence', 'guile', 'intuition'
            ];
            
            const attributeIds = ['might', 'agility', 'passion', 'mind', 'presence'];

            const scoreInputs = [
                'attr-score-might', 'sparks-might-total', 'odyssey-might-total',
                'attr-score-agility', 'sparks-agility-total', 'odyssey-agility-total',
                'attr-score-passion', 'sparks-passion-total', 'odyssey-passion-total',
                'attr-score-mind', 'sparks-mind-total', 'odyssey-mind-total',
                'attr-score-presence', 'sparks-presence-total', 'odyssey-presence-total'
            ];
            const iconMap = {
                'attr-score-might': 'icon-score-might', 'sparks-might-total': 'icon-sparks-might', 'odyssey-might-total': 'icon-odyssey-might',
                'attr-score-agility': 'icon-score-agility', 'sparks-agility-total': 'icon-sparks-agility', 'odyssey-agility-total': 'icon-odyssey-agility',
                'attr-score-passion': 'icon-score-passion', 'sparks-passion-total': 'icon-sparks-passion', 'odyssey-passion-total': 'icon-odyssey-passion',
                'attr-score-mind': 'icon-score-mind', 'sparks-mind-total': 'icon-sparks-mind', 'odyssey-mind-total': 'icon-odyssey-mind',
                'attr-score-presence': 'icon-score-presence', 'sparks-presence-total': 'icon-sparks-presence', 'odyssey-presence-total': 'icon-odyssey-presence'
            };
            const talentIconMap = {
                'strength': 'icon-talent-strength', 'endurance': 'icon-talent-endurance', 'prowess': 'icon-talent-prowess',
                'balance': 'icon-talent-balance', 'finesse': 'icon-talent-finesse', 'focus': 'icon-talent-focus',
                'power': 'icon-talent-power', 'core': 'icon-talent-core', 'creativity': 'icon-talent-creativity',
                'insight': 'icon-talent-insight', 'aptitude': 'icon-talent-aptitude', 'ingenuity': 'icon-talent-ingenuity',
                'influence': 'icon-talent-influence', 'guile': 'icon-talent-guile', 'intuition': 'icon-talent-intuition'
            };

            // --- CORRECTED: 1+2+3+4 Bubble Logic ---
            const rankToBubbleStart = [0, 1, 3, 6, 10];
            const rankToBubbleEnd = [0, 2, 5, 9, 10]; // non-inclusive end for rank 4
            const bubbleToRank = [
                0, // 0
                1, 1, // 1, 2
                2, 2, 2, // 3, 4, 5
                3, 3, 3, 3 // 6, 7, 8, 9
            ];
            
            const icons = { 'S': '', 'DS': '', 'F': '', 'DF': '', 'U': '', 'DU': '' };
            const diceFaces = {
                'd3(4)': [ 'DF', 'DF', 'DF', 'F', 'F', 'F', 'F', 'F', 'F', 'S', 'S', 'S' ],
                'd6':    [ 'DF', 'F', 'F', 'S', 'S', 'U' ],
                'd8':    [ 'S', 'S', 'S', 'F', 'F', 'DF', 'U', 'U' ],
                'd10':   [ 'DF', 'F', 'F', 'S', 'S', 'S', 'DS', 'U', 'U', 'DU' ],
                'd12':   [ 'F', 'F', 'DF', 'S', 'S', 'S', 'DS', 'DS', 'U', 'U', 'DU', 'DU' ]
            };
            let storedUltimates = 0;
            let currentRoll = { successes: 0, fails: 0, ultimates: 0 };
            
            // --- Get Element Refs ---
            const settingsBtn = document.getElementById('settings-btn');
            const modalBackdrop = document.getElementById('settings-modal');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const applyDamageBtn = document.getElementById('apply-damage');
            const applyHealBtn = document.getElementById('apply-heal');
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const rollBtn = document.getElementById('roll-button');
            const tallyUSBtn = document.getElementById('tally-u-s');
            const tallyUFBtn = document.getElementById('tally-u-f');
            const tallyUBankBtn = document.getElementById('tally-u-bank');
            const bankUseSBtn = document.getElementById('bank-use-s');
            const bankUseFBtn = document.getElementById('bank-use-f');
            const applyFailsBtn = document.getElementById('apply-fails-button');
            const addItemBtn = document.getElementById('add-item-btn');
            const itemListEl = document.getElementById('item-list');

            // --- NEW: Item Modal Refs ---
            const addItemModal = document.getElementById('add-item-modal');
            const itemModalSaveBtn = document.getElementById('item-modal-save-btn');
            const itemModalCancelBtn = document.getElementById('item-modal-cancel-btn');
            const itemModalName = document.getElementById('item-modal-name');
            const itemModalDesc = document.getElementById('item-modal-desc');
            const itemModalQty = document.getElementById('item-modal-qty');
            const itemModalValue = document.getElementById('item-modal-value');
            
            
            // ==================================
            // --- MODAL & THEME LOGIC ---
            // ==================================
            if(settingsBtn) settingsBtn.addEventListener('click', () => {
                modalBackdrop.style.display = 'flex';
            });
            if(modalCloseBtn) modalCloseBtn.addEventListener('click', () => {
                modalBackdrop.style.display = 'none';
            });
            if(modalBackdrop) modalBackdrop.addEventListener('click', (e) => {
                if (e.target === modalBackdrop) {
                    modalBackdrop.style.display = 'none';
                }
            });
            if(themeToggleBtn) themeToggleBtn.addEventListener('click', () => {
                document.body.classList.toggle('light-mode');
            });


            // ==================================
            // --- SHARED PIP TRACKER LOGIC ---
            // ==================================
            
            function initializeTrackers() {
                pipCategories.forEach(category => {
                    const maxDisplay = document.querySelector(`.max-pip-input[data-category="${category}"]`);
                    if (!maxDisplay) return;
                    const max = parseInt(maxDisplay.innerText) || 0;
                    trackers[category] = { max: max, t1: max, t2: 0, t3: 0 };
                });
                updatePipUI();
            }

            function updatePipUI() {
                pipCategories.forEach(category => {
                    if (!trackers[category]) return;
                    
                    const t1El = document.getElementById(`${category}-t1`);
                    const t2El = document.getElementById(`${category}-t2`);
                    const t3El = document.getElementById(`${category}-t3`);
                    
                    if (t1El && t2El && t3El) { // Check if elements exist
                        t1El.innerText = trackers[category].t1;
                        t2El.innerText = trackers[category].t2;
                        t3El.innerText = trackers[category].t3;
                    }
                    
                    const attrId = Object.keys(attrToPip).find(key => attrToPip[key] === category);
                    const pipInput = document.getElementById(`pip-${attrId}`);
                    if (pipInput) {
                        pipInput.value = trackers[category].t1; // Set to current pips
                    }
                });
            }

            function setMaxPips(category, max) {
                if (max === undefined) return;
                
                const maxDisplay = document.querySelector(`.max-pip-input[data-category="${category}"]`);
                if(maxDisplay) maxDisplay.innerText = max;
                
                const oldMax = trackers[category] ? trackers[category].max : -1;
                // Only reset pips if the max value has actually changed
                if (!trackers[category] || max !== oldMax) {
                    trackers[category] = { max: max, t1: max, t2: 0, t3: 0 };
                }
                updatePipUI();
            }

            function applyDamage(category, amount) {
                let data = trackers[category];
                if (!data || data.max === 0) return; 

                for (let i = 0; i < amount; i++) {
                    if (data.t3 === data.max) {
                        data.t1 = 0; data.t2 = 0; break; 
                    }
                    if (data.t1 > 0) {
                        data.t1--; data.t2++;
                        if (data.t1 === 0 && data.t2 === data.max) {
                            data.t3++; data.t1 = data.t2 - 1; data.t2 = 0;
                        }
                    } 
                    else if (data.t2 > 0) {
                        data.t3++; data.t1 = data.t2 - 1; data.t2 = 0;
                    }
                }
                if (data.t3 === data.max) { data.t1 = 0; data.t2 = 0; }
                updatePipUI();
                saveCharacterToLocal(); // Auto-save
            }

            function applyHeal(category, amount) {
                let data = trackers[category];
                if (!data || data.max === 0) return;

                for (let i = 0; i < amount; i++) {
                    if (data.t1 === data.max) {
                         data.t2 = 0; data.t3 = 0; break;
                    }
                    if (data.t2 > 0) {
                        data.t2--; data.t1++;
                    }
                    else if (data.t3 > 0) {
                        data.t3--; data.t2++;
                    }
                }
                updatePipUI();
                saveCharacterToLocal(); // Auto-save
            }
            
            if (applyDamageBtn) {
                applyDamageBtn.addEventListener('click', () => {
                    const amount = parseInt(document.getElementById('pip-amount').value);
                    const category = document.getElementById('pip-category').value;
                    if (amount > 0) applyDamage(category, amount);
                });
            }

            if (applyHealBtn) {
                applyHealBtn.addEventListener('click', () => {
                    const amount = parseInt(document.getElementById('pip-amount').value);
                    const category = document.getElementById('pip-category').value;
                    if (amount > 0) applyHeal(category, amount);
                });
            }

            // ==================================
            // --- CHARACTER SHEET LOGIC ---
            // ==================================

            function handleRankClick(clickedIcon) {
                const talentRow = clickedIcon.closest('tr');
                const icons = talentRow.querySelectorAll('.tracker-icon');
                const bubbles = talentRow.querySelectorAll('.tracker-dot');
                const clickedRank = parseInt(clickedIcon.dataset.rank);
                const isTogglingOn = clickedIcon.dataset.toggled !== 'true';

                if (isTogglingOn) {
                    for (let i = 0; i <= clickedRank; i++) icons[i].dataset.toggled = 'true';
                    const bubblesToFill = rankToBubbleStart[clickedRank];
                    for (let i = 0; i < bubblesToFill; i++) {
                        if (bubbles[i]) bubbles[i].classList.add('filled');
                    }
                } else {
                    for (let i = clickedRank; i < icons.length; i++) icons[i].dataset.toggled = 'false';
                    const bubblesToClear = rankToBubbleStart[clickedRank];
                    for (let i = bubblesToClear; i < bubbles.length; i++) {
                        if (bubbles[i]) bubbles[i].classList.remove('filled');
                    }
                }
                updateTalentLevel(talentRow);
                saveCharacterToLocal(); // Auto-save
            }

            function handleBubbleClick(clickedBubble) {
                const talentRow = clickedBubble.closest('tr');
                const icons = talentRow.querySelectorAll('.tracker-icon');
                const bubbles = talentRow.querySelectorAll('.tracker-dot');
                const clickedBubbleIndex = parseInt(clickedBubble.dataset.bubble);
                const isTogglingOn = !clickedBubble.classList.contains('filled');

                if (isTogglingOn) {
                    for (let i = 0; i <= clickedBubbleIndex; i++) {
                        if (bubbles[i]) bubbles[i].classList.add('filled');
                    }
                    const parentRank = bubbleToRank[clickedBubbleIndex];
                    if (parentRank !== undefined) {
                        for (let i = 0; i <= parentRank; i++) icons[i].dataset.toggled = 'true';
                    }
                } else {
                    for (let i = clickedBubbleIndex; i < bubbles.length; i++) {
                        if (bubbles[i]) bubbles[i].classList.remove('filled');
                    }
                    const parentRank = bubbleToRank[clickedBubbleIndex];
                    if (parentRank !== undefined) {
                        let anyBubbleOnInRank = false;
                        const startBubble = rankToBubbleStart[parentRank];
                        const endBubble = rankToBubbleEnd[parentRank];
                        for (let i = startBubble; i <= endBubble; i++) {
                            // Need to check bubbles[i] exists since endBubble can be 10
                            if (bubbles[i] && bubbles[i].classList.contains('filled')) {
                                anyBubbleOnInRank = true; break;
                            }
                        }
                        if (!anyBubbleOnInRank) {
                            for (let i = parentRank; i < icons.length; i++) icons[i].dataset.toggled = 'false';
                        }
                    }
                }
                updateTalentLevel(talentRow);
                saveCharacterToLocal(); // Auto-save
            }

            function updateDiceIcon(inputEl, iconEl, type = 'talent') { 
                if (!inputEl || !iconEl) return;
                const value = parseInt(inputEl.value) || 0;
                if (type === 'attribute') {
                    setRankIcon_Attribute(iconEl, value);
                } else {
                    setRankIcon_Talent(iconEl, value);
                }
            }

            function setRankIcon_Talent(iconEl, value) { 
                if (!iconEl) return;
                iconEl.className = 'dice-rank-icon'; // Reset
                if (value >= 15) iconEl.classList.add('dice-rank-5');
                else if (value >= 10) iconEl.classList.add('dice-rank-4');
                else if (value >= 6) iconEl.classList.add('dice-rank-3');
                else if (value >= 3) iconEl.classList.add('dice-rank-2');
                else if (value >= 1) iconEl.classList.add('dice-rank-1');
                else iconEl.classList.add('dice-rank-none');
            }

            function setRankIcon_Attribute(iconEl, value) {
                if (!iconEl) return;
                iconEl.className = 'dice-rank-icon'; // Reset
                if (value >= 5) iconEl.classList.add('dice-rank-5');
                else if (value === 4) iconEl.classList.add('dice-rank-4');
                else if (value === 3) iconEl.classList.add('dice-rank-3');
                else if (value === 2) iconEl.classList.add('dice-rank-2');
                else if (value === 1) iconEl.classList.add('dice-rank-1');
                else iconEl.classList.add('dice-rank-none');
            }

            function getSIC_Talent(value) { 
                if (value >= 15) return 5; 
                if (value >= 10) return 4; 
                if (value >= 6) return 3;  
                if (value >= 3) return 2;  
                if (value >= 1) return 1;  
                return 0; 
            }

            function getSIC_Attribute(value) {
                if (value >= 5) return 5; 
                if (value === 4) return 4; 
                if (value === 3) return 3;  
                if (value === 2) return 2;  
                if (value === 1) return 1;  
                return 0; 
            }

            function getDiceType_Talent(value) { 
                if (value >= 15) return "d12";   
                if (value >= 10) return "d10";  
                if (value >= 6) return "d8";   
                if (value >= 3) return "d6";   
                if (value >= 1) return "d3(4)";
                return "d6"; 
            }

            function getDiceType_Attribute(value) {
                if (value >= 5) return "d12";   
                if (value === 4) return "d10";  
                if (value === 3) return "d8";   
                if (value === 2) return "d6";   
                if (value === 1) return "d3(4)";
                return "d6"; 
            }

            function calculateMaxPips(attrId) {
                const attrScore = parseInt(document.getElementById(`attr-score-${attrId}`).value) || 0;
                const sparksScore = parseInt(document.getElementById(`sparks-${attrId}-total`).value) || 0;
                const odysseyScore = parseInt(document.getElementById(`odyssey-${attrId}-total`).value) || 0;

                const attrSIC = getSIC_Attribute(attrScore);
                const sparksSIC = getSIC_Talent(sparksScore);
                const odysseySIC = getSIC_Talent(odysseyScore);

                const maxPips = attrSIC + sparksSIC + odysseySIC;
                
                const pipCategory = attrToPip[attrId];
                if (pipCategory) {
                    setMaxPips(pipCategory, maxPips);
                }
            }

            function updateTalentLevel(talentRow) {
                const shapeCount = talentRow.querySelectorAll('.tracker-icon[data-toggled="true"]').length;
                const bubbleCount = talentRow.querySelectorAll('.tracker-dot.filled').length;
                const level = shapeCount + bubbleCount;
                
                const lvlDisplay = talentRow.querySelector('.talent-lvl-display');
                if(lvlDisplay) lvlDisplay.innerText = level;
                
                const lvlIcon = talentRow.querySelector('.dice-rank-icon');
                if(lvlIcon) setRankIcon_Talent(lvlIcon, level); 
            }
            
            function setRowState(talentRow, ranks, bubbles) {
                const icons = talentRow.querySelectorAll('.tracker-icon');
                const dots = talentRow.querySelectorAll('.tracker-dot');
                ranks.forEach((isToggled, index) => { if (icons[index]) icons[index].dataset.toggled = isToggled; });
                bubbles.forEach((isFilled, index) => { if (dots[index]) dots[index].classList.toggle('filled', isFilled); });
                updateTalentLevel(talentRow);
            }
            
            // --- NEW: Auto-Save Function ---
            function saveCharacterToLocal() {
                try {
                    let charData = { talents: {}, attributes: {}, items: [], trackers: {}, storedUltimates: 0 };
                    charData.name = document.getElementById('char-name').value;
                    charData.description = document.getElementById('char-desc').value;
                    
                    talentIds.forEach(id => {
                        const row = document.querySelector(`tr[data-talent-id="${id}"]`);
                        if(row) {
                            charData.talents[id] = {
                                ranks: Array.from(row.querySelectorAll('.tracker-icon')).map(icon => icon.dataset.toggled === 'true'),
                                bubbles: Array.from(row.querySelectorAll('.tracker-dot')).map(dot => dot.classList.contains('filled'))
                            };
                        }
                    });
                    
                    attributeIds.forEach(id => {
                        charData.attributes[id] = {
                            score: document.getElementById(`attr-score-${id}`).value,
                            sparks: document.getElementById(`sparks-${id}-total`).value,
                            odyssey: document.getElementById(`odyssey-${id}-total`).value,
                        };
                    });
                    
                    charData.items = items;
                    charData.trackers = trackers; // Save pip tracker state
                    charData.storedUltimates = storedUltimates; // Save ultimate bank

                    localStorage.setItem('runicSuiteCharacter', btoa(JSON.stringify(charData)));
                    // console.log("Character auto-saved to local storage.");
                } catch (e) {
                    console.error('Error auto-saving character:', e);
                }
            }
            
            // --- NEW: Auto-Load Function ---
            function loadCharacterFromLocal() {
                try {
                    const exportCode = localStorage.getItem('runicSuiteCharacter');
                    if (!exportCode) {
                        console.log("No local character found to load.");
                        return; // No save data found
                    }
                    
                    const charData = JSON.parse(atob(exportCode));
                    document.getElementById('char-name').value = charData.name || '';
                    document.getElementById('char-desc').value = charData.description || '';
                    
                    talentIds.forEach(id => {
                        if (charData.talents && charData.talents[id]) {
                            const row = document.querySelector(`tr[data-talent-id="${id}"]`);
                            const ranks = charData.talents[id].ranks || [false,false,false,false,false];
                            const bubbles = charData.talents[id].bubbles || [false,false,false,false,false,false,false,false,false,false]; // 10 bubbles
                            if(row) setRowState(row, ranks, bubbles);
                        }
                    });

                    attributeIds.forEach(id => {
                        if (charData.attributes && charData.attributes[id]) {
                            document.getElementById(`attr-score-${id}`).value = charData.attributes[id].score || 0;
                            document.getElementById(`sparks-${id}-total`).value = charData.attributes[id].sparks || 0;
                            document.getElementById(`odyssey-${id}-total`).value = charData.attributes[id].odyssey || 0;
                        }
                    });

                    items = charData.items || [];
                    
                    // Load pip tracker state *before* initializing icons
                    if (charData.trackers) {
                        trackers = charData.trackers;
                    }
                    
                    storedUltimates = charData.storedUltimates || 0; // Load ultimate bank
                    
                    renderItems();
                    initializeAllDiceIcons(); // Recalculate all icons and max pips
                    updatePipUI(); // Update pip tracker UI with loaded data
                    updateDiceUI(); // Update ultimate bank UI
                    
                    console.log("Character loaded from local storage.");
                } catch (e) {
                    console.error('Error loading local character:', e);
                    localStorage.removeItem('runicSuiteCharacter'); // Clear bad data
                }
            }

            function exportData() {
                // Use the save function, but get the data for the text box
                saveCharacterToLocal(); // Ensures data is fresh
                const exportCode = localStorage.getItem('runicSuiteCharacter');
                document.getElementById('import-export-data').value = exportCode;
                alert('Export code generated and copied to text box!');
            }

            function importData() {
                try {
                    const exportCode = document.getElementById('import-export-data').value;
                    if (!exportCode) return alert('No data to import.');
                    
                    // Save to local storage and then load from it
                    localStorage.setItem('runicSuiteCharacter', exportCode);
                    loadCharacterFromLocal();
                    
                    alert('Character data loaded successfully!');
                    modalBackdrop.style.display = 'none'; 
                } catch (e) {
                    console.error('Error loading data:', e);
                    alert('Error loading data. The code may be invalid. Check console.');
                }
            }

            function initializeAllDiceIcons() {
                scoreInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    const iconId = iconMap[inputId];
                    const iconEl = document.getElementById(iconId);
                    if (input && iconEl) {
                        if (inputId.startsWith('attr-score-')) {
                            updateDiceIcon(input, iconEl, 'attribute');
                        } else {
                            updateDiceIcon(input, iconEl, 'talent');
                        }
                    }
                });
                document.querySelectorAll('tr[data-talent-id]').forEach(row => updateTalentLevel(row));
                attributeIds.forEach(id => calculateMaxPips(id));
            }
            
            // ==================================
            // --- DICE ROLLER LOGIC (Sidebar) ---
            // ==================================

            function rollDie(dieType) {
                const faces = diceFaces[dieType];
                if (!faces) return 'Error';
                return faces[Math.floor(Math.random() * faces.length)];
            }

            function getSuccessLevel(count) {
                if (count <= 0) return { name: 'None', color: '#888' };
                if (count === 1) return { name: 'Red', color: '#e63946' };
                if (count === 2) return { name: 'Orange', color: '#f4a261' };
                if (count === 3) return { name: 'Yellow', color: '#e9c46a' };
                if (count === 4) return { name: 'Green', color: '#2a9d8f' };
                if (count === 5) return { name: 'Blue', color: '#264653' };
                if (count >= 6) return { name: 'Pink', color: '#ffafcc' };
            }

            function updateDiceUI() {
                document.getElementById('tally-s').innerText = currentRoll.successes;
                document.getElementById('tally-f').innerText = currentRoll.fails;
                document.getElementById('tally-u').innerText = currentRoll.ultimates;
                const level = getSuccessLevel(currentRoll.successes);
                const levelEl = document.getElementById('success-level');
                levelEl.innerText = level.name;
                levelEl.style.backgroundColor = level.color;
                document.getElementById('stored-ultimates-val').innerText = storedUltimates;
            }

            function handleRoll() {
                const dieTypes = [
                    document.getElementById('die-1').value, document.getElementById('die-2').value,
                    document.getElementById('die-3').value, document.getElementById('die-4').value,
                ];
                currentRoll = { successes: 0, fails: 0, ultimates: 0 };
                let rawIcons = [];
                dieTypes.forEach(type => {
                    const result = rollDie(type);
                    rawIcons.push(icons[result] || result);
                    switch (result) {
                        case 'S': currentRoll.successes++; break;
                        case 'DS': currentRoll.successes += 2; break;
                        case 'F': currentRoll.fails++; break;
                        case 'DF': currentRoll.fails += 2; break;
                        case 'U': currentRoll.ultimates++; break;
                        case 'DU': currentRoll.ultimates += 2; break;
                    }
                });
                document.getElementById('raw-roll-results').innerText = rawIcons.join(' ');
                updateDiceUI();
            }

            if (rollBtn) rollBtn.addEventListener('click', handleRoll);

            document.querySelectorAll('.roll-talent-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const attrId = e.target.dataset.attr;
                    const talentId = e.target.dataset.talent; 
                    
                    const talentLvl = parseInt(document.getElementById(`talent-lvl-${talentId}`).innerText) || 0;
                    const attrScore = parseInt(document.getElementById(`attr-score-${attrId}`).value) || 0;
                    const sparksScore = parseInt(document.getElementById(`sparks-${attrId}-total`).value) || 0;
                    const odysseyScore = parseInt(document.getElementById(`odyssey-${attrId}-total`).value) || 0;
                    
                    document.getElementById('die-1').value = getDiceType_Talent(talentLvl);
                    document.getElementById('die-2').value = getDiceType_Attribute(attrScore);
                    document.getElementById('die-3').value = getDiceType_Talent(sparksScore);
                    document.getElementById('die-4').value = getDiceType_Talent(odysseyScore);
                    
                //    handleRoll(); Temp
                    document.getElementById('dice-panel').scrollTop = 0;
                });
            });


            if (tallyUSBtn) tallyUSBtn.addEventListener('click', () => {
                if (currentRoll.ultimates > 0) {
                    currentRoll.ultimates--; currentRoll.successes++; updateDiceUI();
                    saveCharacterToLocal();
                }
            });

            if (tallyUFBtn) tallyUFBtn.addEventListener('click', () => {
                if (currentRoll.ultimates > 0) {
                    currentRoll.ultimates--; currentRoll.fails++; updateDiceUI();
                    saveCharacterToLocal();
                }
            });

            if (tallyUBankBtn) tallyUBankBtn.addEventListener('click', () => {
                if (currentRoll.ultimates > 0) {
                    storedUltimates += currentRoll.ultimates;
                    currentRoll.ultimates = 0;
                    updateDiceUI();
                    saveCharacterToLocal();
                }
            });

            if (bankUseSBtn) bankUseSBtn.addEventListener('click', () => {
                if (storedUltimates > 0) {
                    storedUltimates--; currentRoll.successes++; updateDiceUI();
                    saveCharacterToLocal();
                }
            });

            if (bankUseFBtn) bankUseFBtn.addEventListener('click', () => {
                if (storedUltimates > 0) {
                    storedUltimates--; currentRoll.fails++; updateDiceUI();
                    saveCharacterToLocal();
                }
            });

            if (applyFailsBtn) applyFailsBtn.addEventListener('click', () => {
                if (document.getElementById('special-roll-check').checked) return;
                const amount = currentRoll.fails;
                if (amount > 0) {
                    const category = document.getElementById('roll-aspect-risk').value;
                    applyDamage(category, amount); 
                    currentRoll.fails = 0; 
                    updateDiceUI();
                    saveCharacterToLocal();
                }
            });

            // Initial UI Sync for Dice
            updateDiceUI();

            // ==================================
            // --- ITEMS LOGIC ---
            // ==================================

            if(addItemBtn) addItemBtn.addEventListener('click', () => {
                // Clear old values and show modal
                itemModalName.value = '';
                itemModalDesc.value = '';
                itemModalQty.value = '1';
                itemModalValue.value = '1';
                addItemModal.style.display = 'flex';
                itemModalName.focus();
            });
            
            if(itemModalCancelBtn) itemModalCancelBtn.addEventListener('click', () => {
                addItemModal.style.display = 'none';
            });
            
            if(addItemModal) addItemModal.addEventListener('click', (e) => {
                if (e.target === addItemModal) {
                    addItemModal.style.display = 'none';
                }
            });

            if(itemModalSaveBtn) itemModalSaveBtn.addEventListener('click', () => {
                const name = itemModalName.value || 'New Item';
                const desc = itemModalDesc.value || '';
                const qty = parseInt(itemModalQty.value) || 1;
                const value = parseInt(itemModalValue.value) || 0;
                
                items.push({
                    id: Date.now().toString(),
                    name: name,
                    desc: desc,
                    qty: qty,
                    value: value
                });
                renderItems();
                saveCharacterToLocal();
                addItemModal.style.display = 'none';
            });


            function renderItems() {
                if (!itemListEl) return;
                itemListEl.innerHTML = ''; // Clear list
                if (items.length === 0) {
                    itemListEl.innerHTML = `<p style="color: var(--text-muted); text-align: center; font-size: 0.9rem;">No items yet.</p>`;
                }

                items.forEach((item, index) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'item-entry';
                    itemEl.innerHTML = `
                        <input type="number" class="item-qty" value="${item.qty}" data-index="${index}">
                        <div class="item-details" title="${item.desc}">
                            <span class="item-name">${item.name}</span>
                            <span class="item-desc">${item.desc}</span>
                        </div>
                        <div class="dice-rank-icon item-icon" id="item-icon-${item.id}" data-index="${index}" title="Click to change value (0-5)"></div>
                        <button class="item-delete-btn" data-index="${index}">&times;</button>
                    `;
                    itemListEl.appendChild(itemEl);

                    // Set the icon for the new item
                    const iconEl = itemEl.querySelector('.item-icon');
                    setRankIcon_Attribute(iconEl, item.value); // Use 1-5 logic
                });

                // Add listeners for new buttons/inputs
                itemListEl.querySelectorAll('.item-qty').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        items[index].qty = parseInt(e.target.value) || 0;
                        saveCharacterToLocal();
                    });
                });
                
                // NEW: Click listener for item icon to cycle value
                itemListEl.querySelectorAll('.item-icon').forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        let currentValue = items[index].value || 0;
                        currentValue++;
                        if (currentValue > 5) {
                            currentValue = 0; // Wrap around from 5 back to 0
                        }
                        items[index].value = currentValue;
                        setRankIcon_Attribute(e.target, items[index].value); // Update icon
                        saveCharacterToLocal();
                    });
                });
                
                itemListEl.querySelectorAll('.item-delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        items.splice(index, 1); // Remove item from array
                        renderItems(); // Re-render
                        saveCharacterToLocal();
                    });
                });
            }
            
            // ==================================
            // --- INITIALIZATION ---
            // ==================================
            
            // --- ADDED BACK: Attach tracker listeners ---
            document.querySelectorAll('.tracker-icon').forEach(icon => {
                icon.addEventListener('click', (e) => handleRankClick(e.target));
            });
            document.querySelectorAll('.tracker-dot').forEach(dot => {
                dot.addEventListener('click', (e) => handleBubbleClick(e.target));
            });
            // --- END ADD ---
            
            // --- Auto-save for name/desc ---
            document.getElementById('char-name').addEventListener('input', saveCharacterToLocal);
            document.getElementById('char-desc').addEventListener('input', saveCharacterToLocal);

            // --- Attach Listeners to Inputs ---
            scoreInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', (e) => {
                        const iconId = iconMap[e.target.id];
                        const iconEl = document.getElementById(iconId);
                        
                        if (e.target.id.startsWith('attr-score-')) {
                            updateDiceIcon(e.target, iconEl, 'attribute');
                        } else {
                            updateDiceIcon(e.target, iconEl, 'talent');
                        }
                        
                        const idParts = e.target.id.split('-');
                        const attrId = idParts[1] === 'score' ? idParts[2] : idParts[1];
                        if (attrId && attrToPip[attrId]) {
                            calculateMaxPips(attrId);
                        }
                        saveCharacterToLocal(); // Auto-save
                    });
                }
            });


            initializeTrackers(); // MUST run first to create the trackers object
            initializeAllDiceIcons(); // NOW it's safe to update icons and pips
            renderItems(); // Initial render for items
            
            loadCharacterFromLocal(); // Auto-load character on page start

        });
    </script>

</body>
</html>

            /* Colors */
            --color-red: #e63946;
            --color-orange: #f4a261;
            --color-yellow: #e9c46a;
            --color-green: #2a9d8f;
            --color-blue: #264653;
            --color-purple: #9d4edd;
            --color-grey: #6c757d;
            --color-white: #f8f9fa;

            /* Light/Dark Mode */
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --card-bg-light: #2a2a2a;
            --text-color: #e0e0e0;
            --text-muted: #aaa;
            --border-color: #444;
            --input-bg: #2c2c2c;
            --shadow-color: rgba(0, 0, 0, 0.2);
        }

        body.light-mode {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --card-bg-light: #fdfdfd;
            --text-color: #1c1e21;
            --text-muted: #555;
            --border-color: #ddd;
            --input-bg: #f8f9fa;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        /* --- NEW: No-Scroll Page Layout --- */
        html, body {
            height: 100vh; /* Full viewport height */
            width: 100vw; /* Full viewport width */
            margin: 0;
            overflow: hidden; /* THIS PREVENTS BROWSER SCROLLING */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: grid; /* Use Grid for layout */
            grid-template-columns: 2fr 1fr; /* 2/3 column, 1/3 column */
            grid-template-rows: auto 1fr auto; /* Header, Main Content, Pips */
            grid-template-areas:
                "header header"
                "stats tools-right"
                "pips tools-right";
            padding: 16px;
            gap: 16px;
            box-sizing: border-box;
            font-size: 13px; /* Smaller base font */
        }

        h1, h2, h3 {
            text-align: center;
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 0.5rem; /* Reduced margin */
            flex-shrink: 0;
        }
        h2 { font-size: 1.2rem; }
        h3 { font-size: 0.9rem; margin: 0; }

        /* Generic panel style */
        .panel {
            padding: 12px; /* Reduced padding */
            background-color: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px var(--shadow-color);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* No scrolling */
        }

        /* --- Grid Area Layout --- */
        #header-panel {
            grid-area: header;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
        }
        #stats-panel {
            grid-area: stats;
            overflow-y: auto; /* Internal scroll for talents */
        }
        #pips-panel {
            grid-area: pips;
            flex-shrink: 0;
        }
        #right-column {
            grid-area: tools-right;
            display: grid;
            grid-template-rows: auto 1fr; /* Items, then Dice fills remaining */
            gap: 16px;
            overflow: hidden;
        }
        #items-panel {
            overflow-y: auto; /* Internal scroll for items */
        }
        #dice-panel {
            overflow-y: auto; /* Internal scroll for dice roller */
        }

        /* --- Header Panel --- */
        .char-name-input {
            width: 30%;
            font-size: 1.25rem;
            font-weight: bold;
            padding: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
        }
        .char-desc-textarea {
            width: 50%;
            height: 40px; /* Small */
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem;
            box-sizing: border-box;
            resize: none;
            font-size: 0.9rem;
        }
        
        /* --- Settings Button & Modal --- */
        #settings-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }
        #settings-btn:hover { color: var(--text-color); }
        
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0,0,0,0.6);
            z-index: 100;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            width: 500px;
            max-width: 90%;
            padding: 2rem;
            background-color: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-content h2 { margin-top: 0; }
        .modal-section { margin-bottom: 1.5rem; }
        .modal-section h3 {
            text-align: left;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .import-export { display: flex; flex-direction: column; gap: 10px; }
        .import-export-area {
            width: 100%;
            height: 80px;
            padding: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: none;
            font-family: monospace;
            box-sizing: border-box;
        }
        .modal-btn-group { display: flex; gap: 10px; }
        .modal-btn {
            flex-grow: 1;
            font-size: 1rem;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            color: white;
        }
        #export-btn { background-color: var(--color-blue); }
        #import-btn { background-color: var(--color-green); }
        #theme-toggle-btn { width: 100%; background-color: var(--color-grey); }
        #modal-close-btn, .modal-cancel-btn { 
            width: 100%; 
            background-color: var(--color-red); 
            margin-top: 1rem;
        }
        
        /* --- NEW: Item Modal Styles --- */
        .item-modal-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .item-modal-form label {
            font-weight: bold;
            font-size: 0.9rem;
        }
        .item-modal-form input {
            width: 100%;
            padding: 0.5rem;
            font-size: 1rem;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
        }
        .item-modal-form input[type="number"] {
            -moz-appearance: textfield;
        }
        .item-modal-inputs-row {
            display: flex;
            gap: 1rem;
        }
        .item-modal-inputs-row div {
            flex: 1;
        }
        #item-modal-save-btn { background-color: var(--color-green); margin-top: 1rem; }
        #item-modal-cancel-btn { background-color: var(--color-red); margin-top: 1rem; }


        /* --- CHARACTER SHEET STYLES --- */
        .sheet-table {
            width: 100%;
            margin: 0 auto;
            border-collapse: collapse;
            table-layout: fixed;
        }
        .sheet-table th,
        .sheet-table td {
            border: 1px solid var(--border-color);
            padding: 3px; /* TIGHT padding */
            vertical-align: middle; /* Changed */
            text-align: left;
            word-wrap: break-word;
        }
        .sheet-table th {
            background-color: #333;
            color: var(--white);
            text-align: center;
            font-size: 9px; /* TINY font */
            padding: 3px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* Column Widths */
        .col-talent { width: 10%; }
        .col-uses { width: 12%; }
        .col-tracker { width: 30%; }
        .col-lvl { width: 8%; } 
        .col-attribute { width: 11%; } /* Thinner */
        .col-sparks { width: 11%; } /* Thinner */
        .col-odyssey { width: 11%; } /* Thinner */
        .col-roll { width: 7%; } /* NEW Roll column */

        .talent-name {
            font-weight: bold;
            font-size: 1rem; /* Small */
            margin: 0;
        }
        .talent-uses {
            font-size: 0.75rem; /* Small */
            color: var(--text-muted);
            margin: 0;
        }
        .tracker-icons {
            display: flex;
            justify-content: space-around;
            margin-bottom: 4px; /* TIGHT */
        }
        .tracker-icon {
            width: 18px; /* SMALL */
            height: 18px; /* SMALL */
            border: 2px solid var(--border-color);
            cursor: pointer;
            opacity: 0.3;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 8px; /* TINY */
            user-select: none;
        }
        .tracker-icon[data-toggled="true"] { opacity: 1; border-width: 2px; }
        
        #icon-novice { background-color: var(--color-red); border-color: var(--color-red); border-radius: 50%; }
        #icon-trained { background-color: var(--color-orange); border-color: var(--color-orange); border-radius: 4px; }
        #icon-skilled { background-color: var(--color-yellow); border-color: var(--color-yellow); border-radius: 50%; }
        #icon-expert { background-color: var(--color-green); border-color: var(--color-green); width: 0; height: 0; border-left: 9px solid transparent; border-right: 9px solid transparent; border-bottom: 16px solid var(--color-green); }
        #icon-master { background-color: var(--color-blue); border-color: var(--color-blue); transform: rotate(45deg); }
        
        .tracker-dots {
            display: flex;
            justify-content: space-between;
            background: #222;
            padding: 4px; /* TIGHT */
            border-radius: 4px;
            align-items: center;
        }
        .tracker-dot {
            width: 9px; /* SMALL */
            height: 9px; /* SMALL */
            background-color: #444;
            border-radius: 50%;
            cursor: pointer;
        }
        .tracker-dot.filled { background-color: var(--color-green); }
        /* CORRECTED: 1+2+3+4 layout */
        .tracker-dot:nth-child(1),
        .tracker-dot:nth-child(3),
        .tracker-dot:nth-child(6) {
            margin-right: 6px; /* TIGHT */
        }

        .talent-lvl-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .talent-lvl-display {
            width: 50px; /* NARROW */
            height: 30px; /* SHORT */
            font-size: 1rem; /* Small */
            font-weight: bold;
            text-align: center;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .attr-cell {
            padding: 6px; /* TIGHT */
            background-color: var(--card-bg-light);
            vertical-align: middle; /* Center content vertically */
            text-align: center; /* Center column content */
        }
        .attr-cell h3 {
            margin: 0 0 6px 0;
            text-align: center; /* Center header */
            font-size: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 3px;
        }
        
        .score-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .attr-score-input {
            width: 50px; /* NARROW */
            padding: 4px; /* TIGHT */
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
            text-align: center;
            font-weight: bold;
            -moz-appearance: textfield;
            height: 30px; /* SHORT */
        }
        
        .dice-rank-icon {
            width: 22px; /* SMALL */
            height: 22px; /* SMALL */
            background-color: transparent;
            border: 0;
            transition: all 0.2s ease-in-out;
            margin: 0 auto;
            border-radius: 0;
            transform: rotate(0deg);
            clip-path: none;
        }
        .dice-rank-none { border: 2px dashed var(--border-color); border-radius: 50%; }
        .dice-rank-1 { width: 0; height: 0; border-left: 11px solid transparent; border-right: 11px solid transparent; border-bottom: 19px solid var(--color-red); }
        .dice-rank-2 { background-color: var(--color-orange); border: 2px solid var(--color-orange); border-radius: 4px; }
        .dice-rank-3 { background-color: var(--color-yellow); border: 2px solid var(--color-yellow); transform: rotate(45deg); }
        .dice-rank-4 { width: 0; height: 0; border-left: 11px solid transparent; border-right: 11px solid transparent; border-bottom: 19px solid var(--color-green); }
        .dice-rank-5 { width: 22px; height: 21px; background-color: var(--color-blue); clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%); }

        /* --- Roll Button --- */
        .roll-cell {
            text-align: center;
            vertical-align: middle;
        }
        .roll-talent-btn {
            background: var(--color-blue);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px; /* Smaller */
            height: 32px; /* Smaller */
            cursor: pointer;
            font-size: 9px; /* Smaller */
            font-weight: bold;
            line-height: 1;
            padding: 0;
        }
        .roll-talent-btn:hover {
            opacity: 0.8;
        }

        /* --- Pips Panel --- */
        #pips-panel .panel-content {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }
        .pip-input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            flex-grow: 1;
        }
        .pip-label {
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        .pip-input {
            width: 100%;
            height: 30px; /* SHORT */
            font-size: 1rem; /* SMALL */
            font-weight: bold;
            text-align: center;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 2px solid var(--border-color);
            border-radius: 4px;
            -moz-appearance: textfield;
            box-sizing: border-box;
            /* --- NEW: Make Pips Readonly --- */
            background-color: var(--card-bg-light); 
            opacity: 0.8;
        }
        #pip-might { border-color: var(--color-red); }
        #pip-agility { border-color: var(--color-orange); }
        #pip-passion { border-color: var(--color-yellow); }
        #pip-mind { border-color: var(--color-green); }
        #pip-presence { border-color: var(--color-blue); }

        
        /* --- PIP TRACKER CARDS (NOW IN DICE ROLLER) --- */
        .tracker-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        .tracker-card {
            background-color: var(--card-bg-light);
            border-top: 4px solid;
            border-radius: 8px;
            width: 100%;
            padding: 1rem;
            box-sizing: border-box;
        }
        .tracker-card h2 { margin-top: 0; font-size: 1.1rem; }
        #stamina { border-color: var(--color-red); }
        #dexterity { border-color: var(--color-orange); }
        #essence { border-color: var(--color-yellow); }
        #clarity { border-color: var(--color-green); }
        #grit { border-color: var(--color-blue); }

        .max-pip-setter {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .max-pip-setter label {
            font-size: 0.9rem;
        }
        .max-pip-input { /* Changed from input to div */
            width: 50px;
            padding: 0.25rem;
            font-size: 0.9rem;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            text-align: center;
            font-weight: bold;
            border-radius: 4px;
        }
        .max-pip-setter button {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            background-color: #555;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .pip-zone {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0; /* TIGHT */
            border-bottom: 1px solid #333;
        }
        .pip-zone:last-child { border-bottom: none; }
        .tier-name { font-weight: 500; color: var(--text-muted); font-size: 0.9rem; }
        .pip-value { font-size: 1.1rem; font-weight: bold; min-width: 30px; text-align: right; }
        
        #apply-damage { background-color: var(--color-red); color: white; }
        #apply-heal { background-color: var(--color-green); color: white; }

        
        /* --- DICE ROLLER STYLES --- */
        #dice-roller {
            display: grid;
            grid-template-areas:
                "selection selection"
                "controls controls"
                "results tally"
                "bank bank";
            gap: 1rem; /* TIGHT */
        }
        #dice-selection { grid-area: selection; display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; }
        #dice-controls { grid-area: controls; display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;}
        #dice-results { grid-area: results; }
        #dice-tally { grid-area: tally; }
        #dice-bank { grid-area: bank; text-align: center; border-top: 1px solid var(--border-color); padding-top: 1rem; }

        #dice-roller h3 { margin-top: 0; margin-bottom: 0.5rem; font-size: 1rem; }
        #dice-roller .roll-button { background-color: #0077b6; color: white; font-size: 1rem; padding: 0.5rem 1rem; }
        #dice-roller .special-roll { display: flex; align-items: center; gap: 0.25rem; }
        
        #raw-roll-results { 
            font-size: 1.1rem; 
            letter-spacing: 0.1rem; 
            text-align: center; 
            background: var(--card-bg-light); 
            padding: 0.5rem; 
            border-radius: 6px; 
            min-height: 2rem; 
        }
        
        .tally-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; font-size: 0.9rem; }
        .tally-row .label { font-weight: 500; }
        .tally-row .value { font-weight: bold; font-size: 1.1rem; min-width: 25px; text-align: right; }
        .tally-row .tally-buttons button { font-size: 0.7rem; padding: 0.1rem 0.4rem; margin-left: 0.25rem; }
        
        #success-level { padding: 0.25rem 0.5rem; border-radius: 4px; color: white; font-weight: bold; }
        
        #dice-bank button, #apply-fails-button {
            background-color: #444;
            color: white;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        #apply-fails-button {
            background-color: var(--color-red);
            margin-top: 0.5rem;
            width: 100%;
        }

        /* --- NEW: Custom Select Dropdowns --- */
        #dice-roller select, #pip-controls select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 2rem 0.5rem 1rem; /* Add padding for arrow */
            font-size: 1rem;
            color: var(--text-color);
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23aaa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
        }

        body.light-mode #dice-roller select, 
        body.light-mode #pip-controls select {
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23555' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }
        /* --- End Custom Select --- */
        
        /* --- Items Panel --- */
        #item-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            /* max-height: 200px; /* Removed max-height */
            overflow-y: auto;
            background-color: var(--card-bg-light);
            padding: 8px;
            border-radius: 4px;
        }
        .item-entry {
            display: grid;
            grid-template-columns: 40px 1fr 30px auto; /* Qty, Name/Desc, Icon, Delete */
            gap: 8px;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        .item-qty {
            width: 100%;
            height: 30px;
            text-align: center;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            -moz-appearance: textfield;
        }
        .item-details {
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Fix for ellipsis */
        }
        .item-name {
            font-weight: bold;
            color: var(--text-color);
        }
        .item-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .item-desc:hover {
            white-space: normal;
            overflow: visible;
        }
        .item-icon { /* NEW */
            cursor: pointer;
        }
        .item-delete-btn {
            background: none;
            border: none;
            color: var(--color-red);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }
        #add-item-btn {
            background-color: var(--color-green);
            color: white;
            width: 100%;
            margin-top: 12px;
        }


    </style>
</head>
<body class="dark-mode">

    <!-- 1. Main Header (No Scroll) -->
    <div id="header-panel" class="panel">
        <input type="text" id="char-name" class="char-name-input" placeholder="Character Name">
        <textarea id="char-desc" class="char-desc-textarea" placeholder="Base character descriptions..."></textarea>
        <button id="settings-btn" title="Settings">
            <!-- SVG Gear Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        </button>
    </div>

    <!-- 2. Stats Panel (Left) -->
    <div id="stats-panel" class="panel">
        <table class="sheet-table">
            <thead>
                <tr>
                    <th class="col-talent">TALENT</th>
                    <th class="col-uses">USES</th>
                    <th class="col-tracker">TRACKER</th>
                    <th class="col-lvl">TALENT LVL</th>
                    <th class="col-attribute">ATTRIBUTE</th>
                    <th class="col-sparks">SPARKS</th>
                    <th class="col-odyssey">ODYSSEY ECHOES</th>
                    <th class="col-roll">ROLL</th>
                </tr>
            </thead>
            <tbody>
                <!-- MIGHT -->
                <tr data-talent-id="strength" data-attr-id="might">
                    <td><h3 class="talent-name" style="color: var(--color-red);">STRENGTH</h3></td>
                    <td><p class="talent-uses">Athletics<br>Force</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <!-- 1 + 2 + 3 + 4 = 10 bubbles -->
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-strength">0</div>
                            <div class="dice-rank-icon" id="icon-talent-strength"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #2a1a1c;">
                        <h3>MIGHT</h3>
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="attr-score-might" placeholder="0" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-score-might"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #2a1a1c;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="sparks-might-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-sparks-might"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #2a1a1c;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="odyssey-might-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-odyssey-might"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="might" data-talent="strength">ROLL</button></td>
                </tr>
                <tr data-talent-id="endurance" data-attr-id="might">
                    <td><h3 class="talent-name" style="color: var(--color-red);">ENDURANCE</h3></td>
                    <td><p class="talent-uses">Fortitude<br>Perseverance</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-endurance">0</div>
                            <div class="dice-rank-icon" id="icon-talent-endurance"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="might" data-talent="endurance">ROLL</button></td>
                </tr>
                <tr data-talent-id="prowess" data-attr-id="might">
                    <td><h3 class="talent-name" style="color: var(--color-red);">PROWESS</h3></td>
                    <td><p class="talent-uses">Melee<br>Expertise</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-prowess">0</div>
                            <div class="dice-rank-icon" id="icon-talent-prowess"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="might" data-talent="prowess">ROLL</button></td>
                </tr>
                <!-- AGILITY -->
                <tr data-talent-id="balance" data-attr-id="agility">
                    <td><h3 class="talent-name" style="color: var(--color-orange);">BALANCE</h3></td>
                    <td><p class="talent-uses">Acrobatics<br>Maneuvers</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-balance">0</div>
                            <div class="dice-rank-icon" id="icon-talent-balance"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #2a221a;">
                        <h3>AGILITY</h3>
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="attr-score-agility" placeholder="0" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-score-agility"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #2a221a;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="sparks-agility-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-sparks-agility"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #2a221a;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="odyssey-agility-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-odyssey-agility"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="agility" data-talent="balance">ROLL</button></td>
                </tr>
                <tr data-talent-id="finesse" data-attr-id="agility">
                    <td><h3 class="talent-name" style="color: var(--color-orange);">FINESSE</h3></td>
                    <td><p class="talent-uses">Precision<br>Detail</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-finesse">0</div>
                            <div class="dice-rank-icon" id="icon-talent-finesse"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="agility" data-talent="finesse">ROLL</button></td>
                </tr>
                <tr data-talent-id="focus" data-attr-id="agility">
                    <td><h3 class="talent-name" style="color: var(--color-orange);">FOCUS</h3></td>
                    <td><p class="talent-uses">Accuracy<br>Reaction</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-focus">0</div>
                            <div class="dice-rank-icon" id="icon-talent-focus"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="agility" data-talent="focus">ROLL</button></td>
                </tr>
                <!-- PASSION -->
                <tr data-talent-id="power" data-attr-id="passion">
                    <td><h3 class="talent-name" style="color: var(--color-yellow);">POWER</h3></td>
                    <td><p class="talent-uses">Sorcery<br>Emotion</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-power">0</div>
                            <div class="dice-rank-icon" id="icon-talent-power"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #2a281a;">
                        <h3>PASSION</h3>
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="attr-score-passion" placeholder="0" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-score-passion"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #2a281a;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="sparks-passion-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-sparks-passion"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #2a281a;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="odyssey-passion-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-odyssey-passion"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="passion" data-talent="power">ROLL</button></td>
                </tr>
                <tr data-talent-id="core" data-attr-id="passion">
                    <td><h3 class="talent-name" style="color: var(--color-yellow);">CORE</h3></td>
                    <td><p class="talent-uses">Faith<br>Morality</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-core">0</div>
                            <div class="dice-rank-icon" id="icon-talent-core"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="passion" data-talent="core">ROLL</button></td>
                </tr>
                <tr data-talent-id="creativity" data-attr-id="passion">
                    <td><h3 class="talent-name" style="color: var(--color-yellow);">CREATIVITY</h3></td>
                    <td><p class="talent-uses">Artistry<br>Invention</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-creativity">0</div>
                            <div class="dice-rank-icon" id="icon-talent-creativity"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="passion" data-talent="creativity">ROLL</button></td>
                </tr>
                <!-- MIND -->
                <tr data-talent-id="insight" data-attr-id="mind">
                    <td><h3 class="talent-name" style="color: var(--color-green);">INSIGHT</h3></td>
                    <td><p class="talent-uses">Investigation<br>Awareness</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-insight">0</div>
                            <div class="dice-rank-icon" id="icon-talent-insight"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #1a2a26;">
                        <h3>MIND</h3>
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="attr-score-mind" placeholder="0" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-score-mind"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #1a2a26;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="sparks-mind-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-sparks-mind"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #1a2a26;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="odyssey-mind-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-odyssey-mind"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="mind" data-talent="insight">ROLL</button></td>
                </tr>
                <tr data-talent-id="aptitude" data-attr-id="mind">
                    <td><h3 class="talent-name" style="color: var(--color-green);">APTITUDE</h3></td>
                    <td><p class="talent-uses">Knowledge<br>Memory</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-aptitude">0</div>
                            <div class="dice-rank-icon" id="icon-talent-aptitude"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="mind" data-talent="aptitude">ROLL</button></td>
                </tr>
                <tr data-talent-id="ingenuity" data-attr-id="mind">
                    <td><h3 class="talent-name" style="color: var(--color-green);">INGENUITY</h3></td>
                    <td><p class="talent-uses">Engineering<br>Tactics</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-ingenuity">0</div>
                            <div class="dice-rank-icon" id="icon-talent-ingenuity"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="mind" data-talent="ingenuity">ROLL</button></td>
                </tr>
                <!-- PRESENCE -->
                <tr data-talent-id="influence" data-attr-id="presence">
                    <td><h3 class="talent-name" style="color: var(--color-blue);">INFLUENCE</h3></td>
                    <td><p class="talent-uses">Persuasion<br>Intimidation</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-influence">0</div>
                            <div class="dice-rank-icon" id="icon-talent-influence"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #1a1e2a;">
                        <h3>PRESENCE</h3>
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="attr-score-presence" placeholder="0" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-score-presence"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #1a1e2a;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="sparks-presence-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-sparks-presence"></div>
                        </div>
                    </td>
                    <td class="attr-cell" rowspan="3" style="background-color: #1a1e2a;">
                        <div class="score-container">
                            <input type="number" class="attr-score-input" id="odyssey-presence-total" min="0" value="0">
                            <div class="dice-rank-icon" id="icon-odyssey-presence"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="presence" data-talent="influence">ROLL</button></td>
                </tr>
                <tr data-talent-id="guile" data-attr-id="presence">
                    <td><h3 class="talent-name" style="color: var(--color-blue);">GUILE</h3></td>
                    <td><p class="talent-uses">Deception<br>Stealth</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon"id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-guile">0</div>
                            <div class="dice-rank-icon" id="icon-talent-guile"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="presence" data-talent="guile">ROLL</button></td>
                </tr>
                <tr data-talent-id="intuition" data-attr-id="presence">
                    <td><h3 class="talent-name" style="color: var(--color-blue);">INTUITION</h3></td>
                    <td><p class="talent-uses">Instinct<br>Wisdom</p></td>
                    <td>
                        <div class="tracker-icons">
                            <div class="tracker-icon" id="icon-novice" data-rank="0"></div><div class="tracker-icon" id="icon-trained" data-rank="1"></div><div class="tracker-icon" id="icon-skilled" data-rank="2"></div><div class="tracker-icon" id="icon-expert" data-rank="3"></div><div class="tracker-icon" id="icon-master" data-rank="4"></div>
                        </div>
                        <div class="tracker-dots">
                            <span class="tracker-dot" data-bubble="0"></span>
                            <span class="tracker-dot" data-bubble="1"></span><span class="tracker-dot" data-bubble="2"></span>
                            <span class="tracker-dot" data-bubble="3"></span><span class="tracker-dot" data-bubble="4"></span><span class="tracker-dot" data-bubble="5"></span>
                            <span class="tracker-dot" data-bubble="6"></span><span class="tracker-dot" data-bubble="7"></span><span class="tracker-dot" data-bubble="8"></span><span class="tracker-dot" data-bubble="9"></span>
                        </div>
                    </td>
                    <td>
                        <div class="talent-lvl-container">
                            <div class="talent-lvl-display" id="talent-lvl-intuition">0</div>
                            <div class="dice-rank-icon" id="icon-talent-intuition"></div>
                        </div>
                    </td>
                    <td class="roll-cell"><button class="roll-talent-btn" data-attr="presence" data-talent="intuition">ROLL</button></td>
                </tr>
            </tbody>
        </table>
    </div> <!-- End stats-panel -->

    <!-- 3. Pips Panel (Left) -->
    <div id="pips-panel" class="panel">
        <div class="panel-content">
            <div class="pip-input-container">
                <label for="pip-might" class="pip-label" style="color: var(--color-red);">Stamina</label>
                <input type="number" class="pip-input" id="pip-might" min="0" value="0" readonly>
            </div>
            <div class="pip-input-container">
                <label for="pip-agility" class="pip-label" style="color: var(--color-orange);">Dexterity</label>
                <input type="number" class="pip-input" id="pip-agility" min="0" value="0" readonly>
            </div>
            <div class="pip-input-container">
                <label for="pip-passion" class="pip-label" style="color: var(--color-yellow);">Essence</label>
                <input type="number" class="pip-input" id="pip-passion" min="0" value="0" readonly>
            </div>
            <div class="pip-input-container">
                <label for="pip-mind" class="pip-label" style="color: var(--color-green);">Clarity</label>
                <input type="number" class="pip-input" id="pip-mind" min="0" value="0" readonly>
            </div>
            <div class="pip-input-container">
                <label for="pip-presence" class="pip-label" style="color: var(--color-blue);">Grit</label>
                <input type="number" class="pip-input" id="pip-presence" min="0" value="0" readonly>
            </div>
        </div>
    </div> <!-- End pips-panel -->


    <!-- ========================== -->
    <!-- 4. RIGHT COLUMN (Tools)    -->
    <!-- ========================== -->
    <div id="right-column">
        <!-- 4a. Items Panel -->
        <div id="items-panel" class="panel">
            <h2>Items</h2>
            <div id="item-list">
                <!-- Items will be added here by JS -->
            </div>
            <button id="add-item-btn" class="modal-btn" style="background-color: var(--color-green);">Add New Item</button>
        </div>
        
        <!-- 4b. Dice Panel -->
        <div id="dice-panel" class="panel">
            <!-- Dice Roller -->
            <h2>Dice Roller</h2>
            <div id="dice-roller" class="controls" style="padding: 0; border: 0; box-shadow: none;">
                <div id="dice-selection">
                    <select id="die-1">
                        <option value="d3(4)">d3(4)</option><option value="d6">d6</option><option value="d8" selected>d8</option><option value="d10">d10</option><option value="d12">d12</option>
                    </select>
                    <select id="die-2">
                        <option value="d3(4)">d3(4)</option><option value="d6">d6</option><option value="d8" selected>d8</option><option value="d10">d10</option><option value="d12">d12</option>
                    </select>
                    <select id="die-3">
                        <option value="d3(4)">d3(4)</option><option value="d6" selected>d6</option><option value="d8">d8</option><option value="d10">d10</option><option value="d12">d12</option>
                    </select>
                    <select id="die-4">
                        <option value="d3(4)">d3(4)</option><option value="d6" selected>d6</option><option value="d8">d8</option><option value="d10">d10</option><option value="d12">d12</option>
                    </select>
                </div>
                <div id="dice-controls">
                    <button id="roll-button" class="roll-button">Roll Dice</button>
                    <div class="special-roll">
                        <input type="checkbox" id="special-roll-check">
                        <label for="special-roll-check">Special Roll?</label>
                    </div>
                    <select id="roll-aspect-risk">
                        <option value="stamina">Stamina</option><option value="dexterity">Dexterity</option><option value="essence">Essence</option><option value="clarity">Clarity</option><option value="grit">Grit</option>
                    </select>
                </div>
                <div id="dice-results">
                    <h3>Raw Roll</h3>
                    <div id="raw-roll-results"></div>
                    <h3>Ultimate Bank</h3>
                    <div id="dice-bank">
                        <span>Stored Ultimates: <span id="stored-ultimates-val">0</span></span>
                        <button id="bank-use-s">Spend as (S)</button>
                        <button id="bank-use-f">Spend as (F)</button>
                    </div>
                </div>
                <div id="dice-tally">
                    <h3>Tally</h3>
                    <div class="tally-row">
                        <span class="label">Success Level:</span>
                        <span id="success-level" style="background-color: #888;">None</span>
                    </div>
                    <div class="tally-row">
                        <span class="label">Successes:</span>
                        <span class="value" id="tally-s">0</span>
                    </div>
                    <div class="tally-row">
                        <span class="label">Fails:</span>
                        <span class="value" id="tally-f">0</span>
                    </div>
                    <div class="tally-row">
                        <span class="label">Ultimates:</span>
                        <span class="value" id="tally-u">0</span>
                        <span class="tally-buttons">
                            <button id="tally-u-s">[+S]</button>
                            <button id="tally-u-f">[+F]</button>
                            <button id="tally-u-bank">[Bank]</button>
                        </span>
                    </div>
                    <button id="apply-fails-button">Apply Fails as Damage</button>
                </div>
            </div>

            <!-- Pip Controls -->
            <h2 style="margin-top: 1.5rem;">Pip Controls</h2>
            <div class="controls" id="pip-controls" style="padding: 0; border: 0; box-shadow: none;">
                <label for="pip-amount">Amount:</label>
                <input type="number" id="pip-amount" value="1" min="1">
                <label for="pip-category">For:</label>
                <select id="pip-category">
                    <option value="stamina">Stamina</option>
                    <option value="dexterity">Dexterity</option>
                    <option value="essence">Essence</option>
                    <option value="clarity">Clarity</option>
                    <option value="grit">Grit</option>
                </select>
                <button id="apply-damage">Subtract Pips</button>
                <button id="apply-heal">Add Pips</button>
            </div>
            
            <!-- Pip Tracker Cards (Full) -->
            <div class="tracker-container" id="pip-tracker-section" style="margin-top: 1.5rem;">
                <!-- Stamina -->
                <div class="tracker-card" id="stamina">
                    <h2>Stamina</h2>
                    <div class="max-pip-setter">
                        <label>Max Pips:</label>
                        <!-- Now a div, not an input -->
                        <div class="max-pip-input" data-category="stamina">0</div>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Stalwart:</span>
                        <span class="pip-value" id="stamina-t1">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Fatigued:</span>
                        <span class="pip-value" id="stamina-t2">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Exhausted:</span>
                        <span class="pip-value" id="stamina-t3">0</span>
                    </div>
                </div>
                <!-- Dexterity -->
                <div class="tracker-card" id="dexterity">
                    <h2>Dexterity</h2>
                    <div class="max-pip-setter">
                        <label>Max Pips:</label>
                        <div class="max-pip-input" data-category="dexterity">0</div>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Limber:</span>
                        <span class="pip-value" id="dexterity-t1">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Unsteady:</span>
                        <span class="pip-value" id="dexterity-t2">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Impaired:</span>
                        <span class="pip-value" id="dexterity-t3">0</span>
                    </div>
                </div>
                <!-- Essence -->
                <div class="tracker-card" id="essence">
                    <h2>Essence</h2>
                    <div class="max-pip-setter">
                        <label>Max Pips:</label>
                        <div class="max-pip-input" data-category="essence">0</div>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Energized:</span>
                        <span class="pip-value" id="essence-t1">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Meaning:</span>
                        <span class="pip-value" id="essence-t2">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Hollow:</span>
                        <span class="pip-value" id="essence-t3">0</span>
                    </div>
                </div>
                <!-- Clarity -->
                <div class="tracker-card" id="clarity">
                    <h2>Clarity</h2>
                    <div class="max-pip-setter">
                        <label>Max Pips:</label>
                        <div class="max-pip-input" data-category="clarity">0</div>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Rational:</span>
                        <span class="pip-value" id="clarity-t1">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Unhinged:</span>
                        <span class="pip-value" id="clarity-t2">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Crazed:</span>
                        <span class="pip-value" id="clarity-t3">0</span>
                    </div>
                </div>
                <!-- Grit -->
                <div class="tracker-card" id="grit">
                    <h2>Grit</h2>
                    <div class="max-pip-setter">
                        <label>Max Pips:</label>
                        <div class="max-pip-input" data-category="grit">0</div>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Focused:</span>
                        <span class="pip-value" id="grit-t1">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Distracted:</span>
                        <span class="pip-value" id="grit-t2">0</span>
                    </div>
                    <div class="pip-zone">
                        <span class="tier-name">Withdrawn:</span>
                        <span class="pip-value" id="grit-t3">0</span>
                    </div>
                </div>
            </div> <!-- End tracker-container -->
        </div> <!-- End dice-panel -->
    </div> <!-- End right-column -->


    <!-- ========================== -->
    <!-- 5. Settings Modal (Hidden) -->
    <!-- ========================== -->
    <div id="settings-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2>Settings</h2>
            
            <div class="modal-section">
                <h3>Theme</h3>
                <button id="theme-toggle-btn" class="modal-btn">Toggle Light/Dark Mode</button>
            </div>

            <div class="modal-section">
                <h3>Character Data</h3>
                <div class="import-export">
                    <textarea id="import-export-data" class="import-export-area" placeholder="Paste character code here..."></textarea>
                    <div class="modal-btn-group">
                        <button id="export-btn" class="modal-btn">Generate Export Code</button>
                        <button id="import-btn" class="modal-btn">Load from Code</button>
                    </div>
                </div>
            </div>

            <button id="modal-close-btn" class="modal-btn">Close</button>
        </div>
    </div>
    
    <!-- ========================== -->
    <!-- 6. Add Item Modal (Hidden) -->
    <!-- ========================== -->
    <div id="add-item-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2>Add New Item</h2>
            <div class="item-modal-form">
                <div>
                    <label for="item-modal-name">Item Name</label>
                    <input type="text" id="item-modal-name" placeholder="Potion of Healing">
                </div>
                <div>
                    <label for="item-modal-desc">Description</label>
                    <input type="text" id="item-modal-desc" placeholder="Restores 5 stamina pips.">
                </div>
                <div class="item-modal-inputs-row">
                    <div>
                        <label for="item-modal-qty">Quantity</label>
                        <input type="number" id="item-modal-qty" value="1" min="1">
                    </div>
                    <div>
                        <label for="item-modal-value">Value (0-5)</label>
                        <input type="number" id="item-modal-value" value="1" min="0" max="5">
                    </div>
                </div>
                <div class="modal-btn-group">
                    <button id="item-modal-save-btn" class="modal-btn">Save Item</button>
                    <button id="item-modal-cancel-btn" class="modal-btn modal-cancel-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // ==================================
            // --- TOP-LEVEL DECLARATIONS ---
            // ==================================
            const pipCategories = ['stamina', 'dexterity', 'essence', 'clarity', 'grit'];
            const attrToPip = {
                'might': 'stamina',
                'agility': 'dexterity',
                'passion': 'essence',
                'mind': 'clarity',
                'presence': 'grit'
            };
            let trackers = {};
            let items = [];

            const talentIds = [
                'strength', 'endurance', 'prowess', 'balance', 'finesse', 'focus',
                'power', 'core', 'creativity', 'insight', 'aptitude', 'ingenuity',
                'influence', 'guile', 'intuition'
            ];
            
            const attributeIds = ['might', 'agility', 'passion', 'mind', 'presence'];

            const scoreInputs = [
                'attr-score-might', 'sparks-might-total', 'odyssey-might-total',
                'attr-score-agility', 'sparks-agility-total', 'odyssey-agility-total',
                'attr-score-passion', 'sparks-passion-total', 'odyssey-passion-total',
                'attr-score-mind', 'sparks-mind-total', 'odyssey-mind-total',
                'attr-score-presence', 'sparks-presence-total', 'odyssey-presence-total'
            ];
            const iconMap = {
                'attr-score-might': 'icon-score-might', 'sparks-might-total': 'icon-sparks-might', 'odyssey-might-total': 'icon-odyssey-might',
                'attr-score-agility': 'icon-score-agility', 'sparks-agility-total': 'icon-sparks-agility', 'odyssey-agility-total': 'icon-odyssey-agility',
                'attr-score-passion': 'icon-score-passion', 'sparks-passion-total': 'icon-sparks-passion', 'odyssey-passion-total': 'icon-odyssey-passion',
                'attr-score-mind': 'icon-score-mind', 'sparks-mind-total': 'icon-sparks-mind', 'odyssey-mind-total': 'icon-odyssey-mind',
                'attr-score-presence': 'icon-score-presence', 'sparks-presence-total': 'icon-sparks-presence', 'odyssey-presence-total': 'icon-odyssey-presence'
            };
            const talentIconMap = {
                'strength': 'icon-talent-strength', 'endurance': 'icon-talent-endurance', 'prowess': 'icon-talent-prowess',
                'balance': 'icon-talent-balance', 'finesse': 'icon-talent-finesse', 'focus': 'icon-talent-focus',
                'power': 'icon-talent-power', 'core': 'icon-talent-core', 'creativity': 'icon-talent-creativity',
                'insight': 'icon-talent-insight', 'aptitude': 'icon-talent-aptitude', 'ingenuity': 'icon-talent-ingenuity',
                'influence': 'icon-talent-influence', 'guile': 'icon-talent-guile', 'intuition': 'icon-talent-intuition'
            };

            // --- CORRECTED: 1+2+3+4 Bubble Logic ---
            const rankToBubbleStart = [0, 1, 3, 6, 10];
            const rankToBubbleEnd = [0, 2, 5, 9, 10]; // non-inclusive end for rank 4
            const bubbleToRank = [
                0, // 0
                1, 1, // 1, 2
                2, 2, 2, // 3, 4, 5
                3, 3, 3, 3 // 6, 7, 8, 9
            ];
            
            const icons = { 'S': '', 'DS': '', 'F': '', 'DF': '', 'U': '', 'DU': '' };
            const diceFaces = {
                'd3(4)': [ 'DF', 'DF', 'DF', 'F', 'F', 'F', 'F', 'F', 'F', 'S', 'S', 'S' ],
                'd6':    [ 'DF', 'F', 'F', 'S', 'S', 'U' ],
                'd8':    [ 'S', 'S', 'S', 'F', 'F', 'DF', 'U', 'U' ],
                'd10':   [ 'DF', 'F', 'F', 'S', 'S', 'S', 'DS', 'U', 'U', 'DU' ],
                'd12':   [ 'F', 'F', 'DF', 'S', 'S', 'S', 'DS', 'DS', 'U', 'U', 'DU', 'DU' ]
            };
            let storedUltimates = 0;
            let currentRoll = { successes: 0, fails: 0, ultimates: 0 };
            
            // --- Get Element Refs ---
            const settingsBtn = document.getElementById('settings-btn');
            const modalBackdrop = document.getElementById('settings-modal');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const applyDamageBtn = document.getElementById('apply-damage');
            const applyHealBtn = document.getElementById('apply-heal');
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const rollBtn = document.getElementById('roll-button');
            const tallyUSBtn = document.getElementById('tally-u-s');
            const tallyUFBtn = document.getElementById('tally-u-f');
            const tallyUBankBtn = document.getElementById('tally-u-bank');
            const bankUseSBtn = document.getElementById('bank-use-s');
            const bankUseFBtn = document.getElementById('bank-use-f');
            const applyFailsBtn = document.getElementById('apply-fails-button');
            const addItemBtn = document.getElementById('add-item-btn');
            const itemListEl = document.getElementById('item-list');

            // --- NEW: Item Modal Refs ---
            const addItemModal = document.getElementById('add-item-modal');
            const itemModalSaveBtn = document.getElementById('item-modal-save-btn');
            const itemModalCancelBtn = document.getElementById('item-modal-cancel-btn');
            const itemModalName = document.getElementById('item-modal-name');
            const itemModalDesc = document.getElementById('item-modal-desc');
            const itemModalQty = document.getElementById('item-modal-qty');
            const itemModalValue = document.getElementById('item-modal-value');
            
            
            // ==================================
            // --- MODAL & THEME LOGIC ---
            // ==================================
            if(settingsBtn) settingsBtn.addEventListener('click', () => {
                modalBackdrop.style.display = 'flex';
            });
            if(modalCloseBtn) modalCloseBtn.addEventListener('click', () => {
                modalBackdrop.style.display = 'none';
            });
            if(modalBackdrop) modalBackdrop.addEventListener('click', (e) => {
                if (e.target === modalBackdrop) {
                    modalBackdrop.style.display = 'none';
                }
            });
            if(themeToggleBtn) themeToggleBtn.addEventListener('click', () => {
                document.body.classList.toggle('light-mode');
            });


            // ==================================
            // --- SHARED PIP TRACKER LOGIC ---
            // ==================================
            
            function initializeTrackers() {
                pipCategories.forEach(category => {
                    const maxDisplay = document.querySelector(`.max-pip-input[data-category="${category}"]`);
                    if (!maxDisplay) return;
                    const max = parseInt(maxDisplay.innerText) || 0;
                    trackers[category] = { max: max, t1: max, t2: 0, t3: 0 };
                });
                updatePipUI();
            }

            function updatePipUI() {
                pipCategories.forEach(category => {
                    if (!trackers[category]) return;
                    
                    const t1El = document.getElementById(`${category}-t1`);
                    const t2El = document.getElementById(`${category}-t2`);
                    const t3El = document.getElementById(`${category}-t3`);
                    
                    if (t1El && t2El && t3El) { // Check if elements exist
                        t1El.innerText = trackers[category].t1;
                        t2El.innerText = trackers[category].t2;
                        t3El.innerText = trackers[category].t3;
                    }
                    
                    const attrId = Object.keys(attrToPip).find(key => attrToPip[key] === category);
                    const pipInput = document.getElementById(`pip-${attrId}`);
                    if (pipInput) {
                        pipInput.value = trackers[category].t1; // Set to current pips
                    }
                });
            }

            function setMaxPips(category, max) {
                if (max === undefined) return;
                
                const maxDisplay = document.querySelector(`.max-pip-input[data-category="${category}"]`);
                if(maxDisplay) maxDisplay.innerText = max;
                
                const oldMax = trackers[category] ? trackers[category].max : -1;
                // Only reset pips if the max value has actually changed
                if (!trackers[category] || max !== oldMax) {
                    trackers[category] = { max: max, t1: max, t2: 0, t3: 0 };
                }
                updatePipUI();
            }

            function applyDamage(category, amount) {
                let data = trackers[category];
                if (!data || data.max === 0) return; 

                for (let i = 0; i < amount; i++) {
                    if (data.t3 === data.max) {
                        data.t1 = 0; data.t2 = 0; break; 
                    }
                    if (data.t1 > 0) {
                        data.t1--; data.t2++;
                        if (data.t1 === 0 && data.t2 === data.max) {
                            data.t3++; data.t1 = data.t2 - 1; data.t2 = 0;
                        }
                    } 
                    else if (data.t2 > 0) {
                        data.t3++; data.t1 = data.t2 - 1; data.t2 = 0;
                    }
                }
                if (data.t3 === data.max) { data.t1 = 0; data.t2 = 0; }
                updatePipUI();
                saveCharacterToLocal(); // Auto-save
            }

            function applyHeal(category, amount) {
                let data = trackers[category];
                if (!data || data.max === 0) return;

                for (let i = 0; i < amount; i++) {
                    if (data.t1 === data.max) {
                         data.t2 = 0; data.t3 = 0; break;
                    }
                    if (data.t2 > 0) {
                        data.t2--; data.t1++;
                    }
                    else if (data.t3 > 0) {
                        data.t3--; data.t2++;
                    }
                }
                updatePipUI();
                saveCharacterToLocal(); // Auto-save
            }
            
            if (applyDamageBtn) {
                applyDamageBtn.addEventListener('click', () => {
                    const amount = parseInt(document.getElementById('pip-amount').value);
                    const category = document.getElementById('pip-category').value;
                    if (amount > 0) applyDamage(category, amount);
                });
            }

            if (applyHealBtn) {
                applyHealBtn.addEventListener('click', () => {
                    const amount = parseInt(document.getElementById('pip-amount').value);
                    const category = document.getElementById('pip-category').value;
                    if (amount > 0) applyHeal(category, amount);
                });
            }

            // ==================================
            // --- CHARACTER SHEET LOGIC ---
            // ==================================

            function handleRankClick(clickedIcon) {
                const talentRow = clickedIcon.closest('tr');
                const icons = talentRow.querySelectorAll('.tracker-icon');
                const bubbles = talentRow.querySelectorAll('.tracker-dot');
                const clickedRank = parseInt(clickedIcon.dataset.rank);
                const isTogglingOn = clickedIcon.dataset.toggled !== 'true';

                if (isTogglingOn) {
                    for (let i = 0; i <= clickedRank; i++) icons[i].dataset.toggled = 'true';
                    const bubblesToFill = rankToBubbleStart[clickedRank];
                    for (let i = 0; i < bubblesToFill; i++) {
                        if (bubbles[i]) bubbles[i].classList.add('filled');
                    }
                } else {
                    for (let i = clickedRank; i < icons.length; i++) icons[i].dataset.toggled = 'false';
                    const bubblesToClear = rankToBubbleStart[clickedRank];
                    for (let i = bubblesToClear; i < bubbles.length; i++) {
                        if (bubbles[i]) bubbles[i].classList.remove('filled');
                    }
                }
                updateTalentLevel(talentRow);
                saveCharacterToLocal(); // Auto-save
            }

            function handleBubbleClick(clickedBubble) {
                const talentRow = clickedBubble.closest('tr');
                const icons = talentRow.querySelectorAll('.tracker-icon');
                const bubbles = talentRow.querySelectorAll('.tracker-dot');
                const clickedBubbleIndex = parseInt(clickedBubble.dataset.bubble);
                const isTogglingOn = !clickedBubble.classList.contains('filled');

                if (isTogglingOn) {
                    for (let i = 0; i <= clickedBubbleIndex; i++) {
                        if (bubbles[i]) bubbles[i].classList.add('filled');
                    }
                    const parentRank = bubbleToRank[clickedBubbleIndex];
                    if (parentRank !== undefined) {
                        for (let i = 0; i <= parentRank; i++) icons[i].dataset.toggled = 'true';
                    }
                } else {
                    for (let i = clickedBubbleIndex; i < bubbles.length; i++) {
                        if (bubbles[i]) bubbles[i].classList.remove('filled');
                    }
                    const parentRank = bubbleToRank[clickedBubbleIndex];
                    if (parentRank !== undefined) {
                        let anyBubbleOnInRank = false;
                        const startBubble = rankToBubbleStart[parentRank];
                        const endBubble = rankToBubbleEnd[parentRank];
                        for (let i = startBubble; i <= endBubble; i++) {
                            // Need to check bubbles[i] exists since endBubble can be 10
                            if (bubbles[i] && bubbles[i].classList.contains('filled')) {
                                anyBubbleOnInRank = true; break;
                            }
                        }
                        if (!anyBubbleOnInRank) {
                            for (let i = parentRank; i < icons.length; i++) icons[i].dataset.toggled = 'false';
                        }
                    }
                }
                updateTalentLevel(talentRow);
                saveCharacterToLocal(); // Auto-save
            }

            function updateDiceIcon(inputEl, iconEl, type = 'talent') { 
                if (!inputEl || !iconEl) return;
                const value = parseInt(inputEl.value) || 0;
                if (type === 'attribute') {
                    setRankIcon_Attribute(iconEl, value);
                } else {
                    setRankIcon_Talent(iconEl, value);
                }
            }

            function setRankIcon_Talent(iconEl, value) { 
                if (!iconEl) return;
                iconEl.className = 'dice-rank-icon'; // Reset
                if (value >= 15) iconEl.classList.add('dice-rank-5');
                else if (value >= 10) iconEl.classList.add('dice-rank-4');
                else if (value >= 6) iconEl.classList.add('dice-rank-3');
                else if (value >= 3) iconEl.classList.add('dice-rank-2');
                else if (value >= 1) iconEl.classList.add('dice-rank-1');
                else iconEl.classList.add('dice-rank-none');
            }

            function setRankIcon_Attribute(iconEl, value) {
                if (!iconEl) return;
                iconEl.className = 'dice-rank-icon'; // Reset
                if (value >= 5) iconEl.classList.add('dice-rank-5');
                else if (value === 4) iconEl.classList.add('dice-rank-4');
                else if (value === 3) iconEl.classList.add('dice-rank-3');
                else if (value === 2) iconEl.classList.add('dice-rank-2');
                else if (value === 1) iconEl.classList.add('dice-rank-1');
                else iconEl.classList.add('dice-rank-none');
            }

            function getSIC_Talent(value) { 
                if (value >= 15) return 5; 
                if (value >= 10) return 4; 
                if (value >= 6) return 3;  
                if (value >= 3) return 2;  
                if (value >= 1) return 1;  
                return 0; 
            }

            function getSIC_Attribute(value) {
                if (value >= 5) return 5; 
                if (value === 4) return 4; 
                if (value === 3) return 3;  
                if (value === 2) return 2;  
                if (value === 1) return 1;  
                return 0; 
            }

            function getDiceType_Talent(value) { 
                if (value >= 15) return "d12";   
                if (value >= 10) return "d10";  
                if (value >= 6) return "d8";   
                if (value >= 3) return "d6";   
                if (value >= 1) return "d3(4)";
                return "d6"; 
            }

            function getDiceType_Attribute(value) {
                if (value >= 5) return "d12";   
                if (value === 4) return "d10";  
                if (value === 3) return "d8";   
                if (value === 2) return "d6";   
                if (value === 1) return "d3(4)";
                return "d6"; 
            }

            function calculateMaxPips(attrId) {
                const attrScore = parseInt(document.getElementById(`attr-score-${attrId}`).value) || 0;
                const sparksScore = parseInt(document.getElementById(`sparks-${attrId}-total`).value) || 0;
                const odysseyScore = parseInt(document.getElementById(`odyssey-${attrId}-total`).value) || 0;

                const attrSIC = getSIC_Attribute(attrScore);
                const sparksSIC = getSIC_Talent(sparksScore);
                const odysseySIC = getSIC_Talent(odysseyScore);

                const maxPips = attrSIC + sparksSIC + odysseySIC;
                
                const pipCategory = attrToPip[attrId];
                if (pipCategory) {
                    setMaxPips(pipCategory, maxPips);
                }
            }

            function updateTalentLevel(talentRow) {
                const shapeCount = talentRow.querySelectorAll('.tracker-icon[data-toggled="true"]').length;
                const bubbleCount = talentRow.querySelectorAll('.tracker-dot.filled').length;
                const level = shapeCount + bubbleCount;
                
                const lvlDisplay = talentRow.querySelector('.talent-lvl-display');
                if(lvlDisplay) lvlDisplay.innerText = level;
                
                const lvlIcon = talentRow.querySelector('.dice-rank-icon');
                if(lvlIcon) setRankIcon_Talent(lvlIcon, level); 
            }
            
            function setRowState(talentRow, ranks, bubbles) {
                const icons = talentRow.querySelectorAll('.tracker-icon');
                const dots = talentRow.querySelectorAll('.tracker-dot');
                ranks.forEach((isToggled, index) => { if (icons[index]) icons[index].dataset.toggled = isToggled; });
                bubbles.forEach((isFilled, index) => { if (dots[index]) dots[index].classList.toggle('filled', isFilled); });
                updateTalentLevel(talentRow);
            }
            
            // --- NEW: Auto-Save Function ---
            function saveCharacterToLocal() {
                try {
                    let charData = { talents: {}, attributes: {}, items: [], trackers: {}, storedUltimates: 0 };
                    charData.name = document.getElementById('char-name').value;
                    charData.description = document.getElementById('char-desc').value;
                    
                    talentIds.forEach(id => {
                        const row = document.querySelector(`tr[data-talent-id="${id}"]`);
                        if(row) {
                            charData.talents[id] = {
                                ranks: Array.from(row.querySelectorAll('.tracker-icon')).map(icon => icon.dataset.toggled === 'true'),
                                bubbles: Array.from(row.querySelectorAll('.tracker-dot')).map(dot => dot.classList.contains('filled'))
                            };
                        }
                    });
                    
                    attributeIds.forEach(id => {
                        charData.attributes[id] = {
                            score: document.getElementById(`attr-score-${id}`).value,
                            sparks: document.getElementById(`sparks-${id}-total`).value,
                            odyssey: document.getElementById(`odyssey-${id}-total`).value,
                        };
                    });
                    
                    charData.items = items;
                    charData.trackers = trackers; // Save pip tracker state
                    charData.storedUltimates = storedUltimates; // Save ultimate bank

                    localStorage.setItem('runicSuiteCharacter', btoa(JSON.stringify(charData)));
                    // console.log("Character auto-saved to local storage.");
                } catch (e) {
                    console.error('Error auto-saving character:', e);
                }
            }
            
            // --- NEW: Auto-Load Function ---
            function loadCharacterFromLocal() {
                try {
                    const exportCode = localStorage.getItem('runicSuiteCharacter');
                    if (!exportCode) {
                        console.log("No local character found to load.");
                        return; // No save data found
                    }
                    
                    const charData = JSON.parse(atob(exportCode));
                    document.getElementById('char-name').value = charData.name || '';
                    document.getElementById('char-desc').value = charData.description || '';
                    
                    talentIds.forEach(id => {
                        if (charData.talents && charData.talents[id]) {
                            const row = document.querySelector(`tr[data-talent-id="${id}"]`);
                            const ranks = charData.talents[id].ranks || [false,false,false,false,false];
                            const bubbles = charData.talents[id].bubbles || [false,false,false,false,false,false,false,false,false,false]; // 10 bubbles
                            if(row) setRowState(row, ranks, bubbles);
                        }
                    });

                    attributeIds.forEach(id => {
                        if (charData.attributes && charData.attributes[id]) {
                            document.getElementById(`attr-score-${id}`).value = charData.attributes[id].score || 0;
                            document.getElementById(`sparks-${id}-total`).value = charData.attributes[id].sparks || 0;
                            document.getElementById(`odyssey-${id}-total`).value = charData.attributes[id].odyssey || 0;
                        }
                    });

                    items = charData.items || [];
                    
                    // Load pip tracker state *before* initializing icons
                    if (charData.trackers) {
                        trackers = charData.trackers;
                    }
                    
                    storedUltimates = charData.storedUltimates || 0; // Load ultimate bank
                    
                    renderItems();
                    initializeAllDiceIcons(); // Recalculate all icons and max pips
                    updatePipUI(); // Update pip tracker UI with loaded data
                    updateDiceUI(); // Update ultimate bank UI
                    
                    console.log("Character loaded from local storage.");
                } catch (e) {
                    console.error('Error loading local character:', e);
                    localStorage.removeItem('runicSuiteCharacter'); // Clear bad data
                }
            }

            function exportData() {
                // Use the save function, but get the data for the text box
                saveCharacterToLocal(); // Ensures data is fresh
                const exportCode = localStorage.getItem('runicSuiteCharacter');
                document.getElementById('import-export-data').value = exportCode;
                alert('Export code generated and copied to text box!');
            }

            function importData() {
                try {
                    const exportCode = document.getElementById('import-export-data').value;
                    if (!exportCode) return alert('No data to import.');
                    
                    // Save to local storage and then load from it
                    localStorage.setItem('runicSuiteCharacter', exportCode);
                    loadCharacterFromLocal();
                    
                    alert('Character data loaded successfully!');
                    modalBackdrop.style.display = 'none'; 
                } catch (e) {
                    console.error('Error loading data:', e);
                    alert('Error loading data. The code may be invalid. Check console.');
                }
            }

            function initializeAllDiceIcons() {
                scoreInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    const iconId = iconMap[inputId];
                    const iconEl = document.getElementById(iconId);
                    if (input && iconEl) {
                        if (inputId.startsWith('attr-score-')) {
                            updateDiceIcon(input, iconEl, 'attribute');
                        } else {
                            updateDiceIcon(input, iconEl, 'talent');
                        }
                    }
                });
                document.querySelectorAll('tr[data-talent-id]').forEach(row => updateTalentLevel(row));
                attributeIds.forEach(id => calculateMaxPips(id));
            }
            
            // ==================================
            // --- DICE ROLLER LOGIC (Sidebar) ---
            // ==================================

            function rollDie(dieType) {
                const faces = diceFaces[dieType];
                if (!faces) return 'Error';
                return faces[Math.floor(Math.random() * faces.length)];
            }

            function getSuccessLevel(count) {
                if (count <= 0) return { name: 'None', color: '#888' };
                if (count === 1) return { name: 'Red', color: '#e63946' };
                if (count === 2) return { name: 'Orange', color: '#f4a261' };
                if (count === 3) return { name: 'Yellow', color: '#e9c46a' };
                if (count === 4) return { name: 'Green', color: '#2a9d8f' };
                if (count === 5) return { name: 'Blue', color: '#264653' };
                if (count >= 6) return { name: 'Pink', color: '#ffafcc' };
            }

            function updateDiceUI() {
                document.getElementById('tally-s').innerText = currentRoll.successes;
                document.getElementById('tally-f').innerText = currentRoll.fails;
                document.getElementById('tally-u').innerText = currentRoll.ultimates;
                const level = getSuccessLevel(currentRoll.successes);
                const levelEl = document.getElementById('success-level');
                levelEl.innerText = level.name;
                levelEl.style.backgroundColor = level.color;
                document.getElementById('stored-ultimates-val').innerText = storedUltimates;
            }

            function handleRoll() {
                const dieTypes = [
                    document.getElementById('die-1').value, document.getElementById('die-2').value,
                    document.getElementById('die-3').value, document.getElementById('die-4').value,
                ];
                currentRoll = { successes: 0, fails: 0, ultimates: 0 };
                let rawIcons = [];
                dieTypes.forEach(type => {
                    const result = rollDie(type);
                    rawIcons.push(icons[result] || result);
                    switch (result) {
                        case 'S': currentRoll.successes++; break;
                        case 'DS': currentRoll.successes += 2; break;
                        case 'F': currentRoll.fails++; break;
                        case 'DF': currentRoll.fails += 2; break;
                        case 'U': currentRoll.ultimates++; break;
                        case 'DU': currentRoll.ultimates += 2; break;
                    }
                });
                document.getElementById('raw-roll-results').innerText = rawIcons.join(' ');
                updateDiceUI();
            }

            if (rollBtn) rollBtn.addEventListener('click', handleRoll);

            document.querySelectorAll('.roll-talent-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const attrId = e.target.dataset.attr;
                    const talentId = e.target.dataset.talent; 
                    
                    const talentLvl = parseInt(document.getElementById(`talent-lvl-${talentId}`).innerText) || 0;
                    const attrScore = parseInt(document.getElementById(`attr-score-${attrId}`).value) || 0;
                    const sparksScore = parseInt(document.getElementById(`sparks-${attrId}-total`).value) || 0;
                    const odysseyScore = parseInt(document.getElementById(`odyssey-${attrId}-total`).value) || 0;
                    
                    document.getElementById('die-1').value = getDiceType_Talent(talentLvl);
                    document.getElementById('die-2').value = getDiceType_Attribute(attrScore);
                    document.getElementById('die-3').value = getDiceType_Talent(sparksScore);
                    document.getElementById('die-4').value = getDiceType_Talent(odysseyScore);
                    
                    handleRoll();
                    document.getElementById('dice-panel').scrollTop = 0;
                });
            });


            if (tallyUSBtn) tallyUSBtn.addEventListener('click', () => {
                if (currentRoll.ultimates > 0) {
                    currentRoll.ultimates--; currentRoll.successes++; updateDiceUI();
                    saveCharacterToLocal();
                }
            });

            if (tallyUFBtn) tallyUFBtn.addEventListener('click', () => {
                if (currentRoll.ultimates > 0) {
                    currentRoll.ultimates--; currentRoll.fails++; updateDiceUI();
                    saveCharacterToLocal();
                }
            });

            if (tallyUBankBtn) tallyUBankBtn.addEventListener('click', () => {
                if (currentRoll.ultimates > 0) {
                    storedUltimates += currentRoll.ultimates;
                    currentRoll.ultimates = 0;
                    updateDiceUI();
                    saveCharacterToLocal();
                }
            });

            if (bankUseSBtn) bankUseSBtn.addEventListener('click', () => {
                if (storedUltimates > 0) {
                    storedUltimates--; currentRoll.successes++; updateDiceUI();
                    saveCharacterToLocal();
                }
            });

            if (bankUseFBtn) bankUseFBtn.addEventListener('click', () => {
                if (storedUltimates > 0) {
                    storedUltimates--; currentRoll.fails++; updateDiceUI();
                    saveCharacterToLocal();
                }
            });

            if (applyFailsBtn) applyFailsBtn.addEventListener('click', () => {
                if (document.getElementById('special-roll-check').checked) return;
                const amount = currentRoll.fails;
                if (amount > 0) {
                    const category = document.getElementById('roll-aspect-risk').value;
                    applyDamage(category, amount); 
                    currentRoll.fails = 0; 
                    updateDiceUI();
                    saveCharacterToLocal();
                }
            });

            // Initial UI Sync for Dice
            updateDiceUI();

            // ==================================
            // --- ITEMS LOGIC ---
            // ==================================

            if(addItemBtn) addItemBtn.addEventListener('click', () => {
                // Clear old values and show modal
                itemModalName.value = '';
                itemModalDesc.value = '';
                itemModalQty.value = '1';
                itemModalValue.value = '1';
                addItemModal.style.display = 'flex';
                itemModalName.focus();
            });
            
            if(itemModalCancelBtn) itemModalCancelBtn.addEventListener('click', () => {
                addItemModal.style.display = 'none';
            });
            
            if(addItemModal) addItemModal.addEventListener('click', (e) => {
                if (e.target === addItemModal) {
                    addItemModal.style.display = 'none';
                }
            });

            if(itemModalSaveBtn) itemModalSaveBtn.addEventListener('click', () => {
                const name = itemModalName.value || 'New Item';
                const desc = itemModalDesc.value || '';
                const qty = parseInt(itemModalQty.value) || 1;
                const value = parseInt(itemModalValue.value) || 0;
                
                items.push({
                    id: Date.now().toString(),
                    name: name,
                    desc: desc,
                    qty: qty,
                    value: value
                });
                renderItems();
                saveCharacterToLocal();
                addItemModal.style.display = 'none';
            });


            function renderItems() {
                if (!itemListEl) return;
                itemListEl.innerHTML = ''; // Clear list
                if (items.length === 0) {
                    itemListEl.innerHTML = `<p style="color: var(--text-muted); text-align: center; font-size: 0.9rem;">No items yet.</p>`;
                }

                items.forEach((item, index) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'item-entry';
                    itemEl.innerHTML = `
                        <input type="number" class="item-qty" value="${item.qty}" data-index="${index}">
                        <div class="item-details" title="${item.desc}">
                            <span class="item-name">${item.name}</span>
                            <span class="item-desc">${item.desc}</span>
                        </div>
                        <div class="dice-rank-icon item-icon" id="item-icon-${item.id}" data-index="${index}" title="Click to change value (0-5)"></div>
                        <button class="item-delete-btn" data-index="${index}">&times;</button>
                    `;
                    itemListEl.appendChild(itemEl);

                    // Set the icon for the new item
                    const iconEl = itemEl.querySelector('.item-icon');
                    setRankIcon_Attribute(iconEl, item.value); // Use 1-5 logic
                });

                // Add listeners for new buttons/inputs
                itemListEl.querySelectorAll('.item-qty').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        items[index].qty = parseInt(e.target.value) || 0;
                        saveCharacterToLocal();
                    });
                });
                
                // NEW: Click listener for item icon to cycle value
                itemListEl.querySelectorAll('.item-icon').forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        let currentValue = items[index].value || 0;
                        currentValue++;
                        if (currentValue > 5) {
                            currentValue = 0; // Wrap around from 5 back to 0
                        }
                        items[index].value = currentValue;
                        setRankIcon_Attribute(e.target, items[index].value); // Update icon
                        saveCharacterToLocal();
                    });
                });
                
                itemListEl.querySelectorAll('.item-delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        items.splice(index, 1); // Remove item from array
                        renderItems(); // Re-render
                        saveCharacterToLocal();
                    });
                });
            }
            
            // ==================================
            // --- INITIALIZATION ---
            // ==================================
            
            // --- ADDED BACK: Attach tracker listeners ---
            document.querySelectorAll('.tracker-icon').forEach(icon => {
                icon.addEventListener('click', (e) => handleRankClick(e.target));
            });
            document.querySelectorAll('.tracker-dot').forEach(dot => {
                dot.addEventListener('click', (e) => handleBubbleClick(e.target));
            });
            // --- END ADD ---
            
            // --- Auto-save for name/desc ---
            document.getElementById('char-name').addEventListener('input', saveCharacterToLocal);
            document.getElementById('char-desc').addEventListener('input', saveCharacterToLocal);

            // --- Attach Listeners to Inputs ---
            scoreInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', (e) => {
                        const iconId = iconMap[e.target.id];
                        const iconEl = document.getElementById(iconId);
                        
                        if (e.target.id.startsWith('attr-score-')) {
                            updateDiceIcon(e.target, iconEl, 'attribute');
                        } else {
                            updateDiceIcon(e.target, iconEl, 'talent');
                        }
                        
                        const idParts = e.target.id.split('-');
                        const attrId = idParts[1] === 'score' ? idParts[2] : idParts[1];
                        if (attrId && attrToPip[attrId]) {
                            calculateMaxPips(attrId);
                        }
                        saveCharacterToLocal(); // Auto-save
                    });
                }
            });


            initializeTrackers(); // MUST run first to create the trackers object
            initializeAllDiceIcons(); // NOW it's safe to update icons and pips
            renderItems(); // Initial render for items
            
            loadCharacterFromLocal(); // Auto-load character on page start

        });
    </script>

</body>
</html>
